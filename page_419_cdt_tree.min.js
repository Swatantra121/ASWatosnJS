var g_before_edit_ele,g_temp_json,g_before_edit_label="",g_before_edit_node={},g_node_master=[],g_node_index=[],g_parent_master=[],g_node_no_arr=[],g_parent_no_arr=[],g_id_no_arr=[],g_final_node_list=[],g_matrixRegex=/matrix\((-?\d*\.?\d+),\s*0,\s*0,\s*(-?\d*\.?\d+),\s*0,\s*0\)/,g_img_zoom_scale=parseFloat($v("P419_CDT_IMG_ZOOM_SCALE")),g_tree_zoom_scale=parseFloat($v("P419_CDT_TREE_ZOOM_SCALE"));function getMembers(e){e.forEach((function(e,t){var n=e.icon.split("-");g_node_no_arr.push(n[5]),g_parent_no_arr.push(n[6]),g_node_master.push(e.label),g_node_index.push(t),g_id_no_arr.push(e.id),g_parent_master.push(null!==e._parent?e._parent.label:""),e.children&&getMembers(e.children)}))}function getWidthOfInput(e){var t=document.createElement("span");t.className="input-element tmp-element",t.style.fontWeight="bold",t.style.fontSize="1.5vh",t.innerHTML=e.value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),document.body.appendChild(t);var n=t.getBoundingClientRect().width;return document.body.removeChild(t),n/window.devicePixelRatio+10}function arrayObjectIndexOf(e,t,n){for(var o=0,r=e.length;o<r;o++)if(e[o][n]===t)return o;return-1}function set_node_details(e){$("#"+e).length>0&&($("#"+e+" .a-TreeView-content").children("span.a-item-cnt").each((function(t){$("#item_cnt_"+t).remove();var n=$(this).attr("class"),o=n.substring(n.indexOf(" ")+1).split("-");$("#"+e+" .a-TreeView-content").eq(t).append('<div id="item_cnt_'+t+'">> '+o[3]+" Items</div>")})),$("#"+e+"_0 .a-TreeView-label").css("font-size","1.5vh").css("font-weight","bold"))}function delete_node(e,t){var n=$("#"+e),o=n.treeView("getSelection"),r=n.treeView("getSelectedNodes")[0].id,i=$("#"+e).treeView("getSelectedNodes");if(null==i[0]._parent)alert(get_message("CDT_FIRST_LVL_ERR"));else{var a=i[0].icon.split("-"),d=n.treeView("getSelectedNodes")[0].label,s=n.treeView("getSelectedNodes")[0]._parent.label,_=n.treeView("getSelectedNodes")[0]._parent.icon.split("-"),l=n.treeView("getSelectedNodes")[0].icon.split("-"),c=null!==n.treeView("getSelectedNodes")[0]._parent._parent?n.treeView("getSelectedNodes")[0]._parent._parent.label:null;console.log("selected_node",i,i[0]);var g=n.treeView("getSelectedNodes")[0]._parent.icon.split("-")[3],u=n.treeView("getSelectedNodes")[0]._parent.children.length;console.log("size",g,c,s,d,r,i[0],i[0].children),a[3]>0||i[0].children.length>0?i[0].children.length>0?alert(get_message("CDT_PARENT_NO_DEL")):g!=a[3]||u>1?alert(get_message("CDT_NO_DEL_WITH_ITEM")):confirm(get_message("SHCT_DELETE_CONFIRM_MSG"),get_message("SHCT_YES"),get_message("SHCT_NO"),(function(){apex.server.process("DELETE_MEMBER",{x01:r,x02:d,x03:s,x04:c,x05:l[5],x06:_[5],x07:t},{dataType:"text",success:function(r){if(""==$.trim(r)){n.treeView("deleteNodes",o),apex.event.trigger("#P419_MOVE_MULTIPLE","apexrefresh"),apex.message.showPageSuccess("Node Deleted"),async function(){apex.region("item_details").refresh(),apex.region("node_details").refresh(),$("#"+e).treeView("refresh"),await update_node_index("",e,t),set_node_details(e)}()}}})})):confirm(get_message("SHCT_DELETE_CONFIRM_MSG"),get_message("SHCT_YES"),get_message("SHCT_NO"),(function(){apex.server.process("DELETE_MEMBER",{x01:r,x02:d,x03:s,x04:c,x05:l[5],x06:_[5],x07:t},{dataType:"text",success:function(r){if(""==$.trim(r)){n.treeView("deleteNodes",o),apex.region("item_details").refresh(),apex.region("node_details").refresh(),apex.event.trigger("#P419_MOVE_MULTIPLE","apexrefresh"),apex.message.showPageSuccess("Node Deleted"),async function(){apex.region("item_details").refresh(),apex.region("node_details").refresh(),$("#"+e).treeView("refresh"),await update_node_index("",e,t),set_node_details(e)}()}}})}))}}function update_node_index(e,t,n){var o=$v("P419_PREV_EXPND_NODES");return console.log("p_need_state",e),new Promise((function(r,i){var a=[$("#"+t).treeView("getNodeAdapter").data];g_node_master=[],g_node_index=[],g_parent_master=[],g_node_no_arr=[],g_parent_no_arr=[],g_id_no_arr=[],getMembers(a),console.log("g_node_master",g_node_master,g_parent_master),apex.server.process("UPDATE_NODE_INDEX",{x01:n,f01:g_node_master,f02:g_node_index,f03:g_parent_master,f04:g_node_no_arr,f05:g_parent_no_arr,f06:g_id_no_arr},{dataType:"text",success:function(i){console.log("update node index done ",i,"need state ",e," assortment ",n," prev ",o),apex.server.process("UPDATE_NODE_NO",{x01:e,x02:n,x03:o},{dataType:"json",success:function(e){console.log("update node no done");var o=void 0!==e.need_no?e.need_no:"",i=void 0!==e.final_expand_node?e.final_expand_node:"";$s("P419_PREV_EXPND_NODES",i),async function(e){await update_final_icon_details(t,n),r(e)}(o)}})}})}))}function update_final_icon_details(e,t){return new Promise((function(n,o){apex.server.process("UPDATE_NEED_SEQ",{x01:t},{dataType:"text",success:function(t){if(""!==$.trim(t)){console.log($.trim(t)),g_temp_json=$.trim(t),console.log("g_temp_json",JSON.parse(g_temp_json));try{g_final_node_list=[],g_final_node_list=JSON.parse($.trim(t));for(const t of g_final_node_list){var o=$("#"+e).treeView("find",{depth:-1,match:function(e){return e.id==t.C004&&e.label==t.C001}}),r=$("#"+e).treeView("getNodes",o);if(void 0!==r&&r.length>0){var i=r[0].icon.split("-");i[3]=null==t.C006||""==t.C006?0:t.C006,i[5]=t.N003,r[0].id=t.N003,i[6]=null==t.N004?"":t.N004,r[0].icon=i.join("-"),$(o).find("span").first().attr("class","a-item-cnt "+i.join("-"))}}n("SUCCESS")}catch(e){apex.message.clearErrors(),apex.message.showErrors([{type:"error",location:"page",message:get_message("SAR_JSON_PARSE_ERROR")}]),n("FAIL")}}}})}))}function add_node(e,t,n){var o,r,i=$("#"+t),a=($("#"+t).treeView("getSelection"),$("#"+t).treeView("getSelectedNodes")),d=(i.treeView("getSelectedNodes").id,"M"==$v("P419_CDT_SEARCH_TYPE")?$v("P419_GROUP"):$v("P419_POG_DIV")),s="M"==$v("P419_CDT_SEARCH_TYPE")?$v("P419_DEPT"):$v("P419_POG_DEPT"),_="M"==$v("P419_CDT_SEARCH_TYPE")?$v("P419_CLASS"):$v("P419_POG_SUBDEPT"),l=$v("P419_SELECTED_NODE");if(null==a[0]._parent&&"AAB"!==e)alert(get_message("CDT_TOP_ERR"));else{if("AAF"==e)console.log("AAF"),o=$("#"+t).treeView("find",{depth:-1,match:function(e){return e.id==a[0]._parent.id}}),r=$("#"+t).treeView("getNodes",o),l=r[0].label;else if("AAA"==e){if(console.log("AAA"),null!==a[0]._parent)var c=$("#"+t).treeView("find",{depth:-1,match:function(e){return e.id==a[0]._parent.id}});null!==(r=$("#"+t).treeView("getNodes",c))[0]._parent&&(o=$("#"+t).treeView("find",{depth:-1,match:function(e){return e.id==r[0]._parent.id}}),l=$("#"+t).treeView("getNodes",o)[0].label)}else o=$("#"+t).treeView("getSelection");"AAA"==e&&null==r[0]._parent?alert(get_message("CDT_ABOVE_TOP_ERR")):apex.server.process("GET_NEW_NODE_ID",{x01:""},{dataType:"text",success:function(r){if(""!==$.trim(r)){var a=$.trim(r);console.log("newNodeID",a);var c=$("#"+t).treeView("getNodes",o),g=c[0].icon.split("-");console.log("parent_details[0].icon",c[0].icon,g,c[0]),apex.server.process("MAX_NODE_VALIDATION",{x01:l,x02:e,x03:"Child Node"+a,x04:a,x05:g[5],x06:n},{dataType:"text",success:function(r){if(""!==$.trim(r))alert($.trim(r));else{var c=$("#"+t).treeView("getNodes",o),g=c[0].icon.split("-");console.log("sunaina"+g),console.log("parent_details ",c,d,s,_,l,$.trim(r),e,g[5]),apex.server.process("ADD_NODE",{x01:d,x02:s,x03:_,x04:"Child Node"+a,x05:l,x06:$.trim(r),x07:e,x08:g[5],x09:n},{dataType:"text",success:function(e){if(""!==$.trim(e)){var r=$.trim(e).split("-");if(console.log("detail_arr cnt ",r),"cnt"==r[0]){var d={};d.icon="asw-item-cnt-"+r[1]+"-Y-"+r[2]+"-"+r[3],d.label="Child Node"+a,d.tooltip="Child Node"+a,d.id=a,d._parent=o,d.children=[],console.log("node_details",d),i.treeView("addNode",o,2,d),console.log("parent_details 1",c);var s=c[0].icon.split("-");s[4]="N",c[0].icon=s.join("-"),console.log("parent_details 2",c),console.log("node added")}}!async function(){console.log("before node index");var e=await update_node_index("Child Node"+a,t,n);console.log("returnval inside something",e);var o=e.split("-"),r=$("#"+t).treeView("find",{depth:-1,match:function(e){return e.id==a}}),i=$("#"+t).treeView("getNodes",r),d=i[0].icon.split("-");console.log("after update",i,d),d[5]=o[0].replace("\n",""),d[6]=o[1].replace("\n",""),i[0].icon=d.join("-"),$s("P419_SELECTED_CHILD_LIST",`${d[5]}`),$s("P419_SELECT_NEED_SEQ",`${d[5]}`),apex.region("item_details").refresh(),apex.region("node_details").refresh(),apex.event.trigger("#P419_MOVE_MULTIPLE","apexrefresh"),set_node_details(t),apex.message.showPageSuccess("Node Added")}()}})}}})}}})}}function update_node(e,t,n,o){if("complete"==t.status){$("#"+n);var r=g_before_edit_node.id;if(g_before_edit_node.label.toUpperCase()!==g_before_edit_label.toUpperCase()){var i=g_before_edit_node.icon.split("-");console.log("before_edit_nodek",g_before_edit_node.label,i[5]),apex.server.process("CHECK_DUPLICATE",{x01:g_before_edit_node.label,x02:i[5],x03:o},{dataType:"text",success:function(e){if(""==$.trim(e)&&g_before_edit_node.label.length<255){var t=g_before_edit_node.icon.split("-");apex.server.process("UPDATE_NODE",{x01:r,x02:g_before_edit_node.label,x03:g_before_edit_label,x04:t[5],x05:t[6],x06:o},{dataType:"text",success:function(e){if(console.log("updated text",$.trim(e)),"node updated"==$.trim(e)){var t=$("#"+n).treeView("find",{depth:-1,match:function(e){return e.id==r}});$("#"+n).treeView("getNodes",t)[0].tooltip=g_before_edit_node.label,apex.region("node_details").refresh(),apex.event.trigger("#P419_MOVE_MULTIPLE","apexrefresh"),set_node_details(n)}}})}else{g_before_edit_node.label.length>255?alert(get_message("CDT_MAX_TEXT_LIMIT_ERR")):alert($.trim(e));var i=$("#"+n).treeView("find",{depth:-1,match:function(e){return e.id==r}});$("#"+n).treeView("getNodes",i)[0].label=g_before_edit_label,set_node_details(n)}}})}}set_node_details(n)}function save_node_detail(){var[e,t]=getAssormentDetails(),n=$("#"+t),o=apex.region("node_details").widget().interactiveGrid("getViews","grid").model,r=[],i=[];o.forEach((function(e){if(""!==o.getValue(e,"MOVE_TO").v){var t={},n=o.getValue(e,"MOVE_TO").v.split("-");r.push(n[1]),t.NeedState=o.getValue(e,"NEED_STATE"),t.MoveTo=n[1],t.PNodeLevel=parseInt(n[3]),t.NeedNo=o.getValue(e,"NODE_NO"),t.ParentNo=o.getValue(e,"PARENT_NO"),t.NodeLevel=parseInt(o.getValue(e,"NODE_LEVEL")),i.push(t)}}));var a="";for(obj of i){var d=n.treeView("find",{depth:-1,match:function(e){return e.id==obj.NeedNo}}),s=n.treeView("getNodes",d),_=n.treeView("find",{depth:-1,match:function(e){return e.id==obj.MoveTo}}),l=n.treeView("getNodes",_);void 0===l[0].children&&(l[0].children=[]),void 0===s[0].children&&(s[0].children=[]),0==l[0].children.length&&s[0].children.length>0&&(a=a+", "+obj.NeedState)}""!==a?alert(get_message("CDT_NODE_MOVE_ERROR_LEAF",a.substring(2))):(addLoadingIndicator(),invokeIGSave("node_details",(async function(){!async function(){var o=function(){console.log("UpdateNode"+i+t)},r=n.treeView("getNodeAdapter"),a=[];for(obj of i){var d=n.treeView("find",{depth:-1,match:function(e){return e.id==obj.NeedNo}}),s=n.treeView("getNodes",d),_=n.treeView("find",{depth:-1,match:function(e){return e.id==obj.MoveTo}}),l=n.treeView("getNodes",_);void 0===l[0].children&&(l[0].children=[]),a.push(l[0].id),r.moveNodes(l[0],1,s,o)}for(obj of(n.treeView("refresh"),a)){var c=n.treeView("find",{depth:-1,match:function(e){return e.id==obj}});n.treeView("expand",c);var g=n.treeView("getNodes",c);g[0]&&getParentArray(g[0]).forEach((function(e){var t=n.treeView("getTreeNode",e);n.treeView("expand",t)}))}await update_node_index("",t,e),set_node_details(t),apex.region("node_details").widget().interactiveGrid("getViews").grid.model.clearChanges(),apex.region("node_details").widget().interactiveGrid("getActions").set("edit",!1),apex.region("node_details").refresh(),apex.message.showPageSuccess(apex.lang.getMessage("APEX.IG.CHANGES_SAVED")),removeLoadingIndicator(regionloadWait)}()})))}function save_item_detail(){var[e,t]=getAssormentDetails();addLoadingIndicator();console.log("grid",apex.region("item_details").widget().interactiveGrid("getViews").grid.model.isChanged()),apex.region("item_details").widget().interactiveGrid("getViews").grid.model.isChanged()&&invokeIGSave("item_details",(function(){!async function(){await update_items_refresh()}()}))}async function update_items_refresh(){var[e,t]=getAssormentDetails();apex.message.showPageSuccess(apex.lang.getMessage("APEX.IG.CHANGES_SAVED")),apex.region("item_details").widget().interactiveGrid("getViews").grid.model.clearChanges(),apex.region("item_details").widget().interactiveGrid("getActions").set("edit",!1),apex.region("item_details").refresh(),$("#"+t).treeView("refresh"),await update_node_index("",t,e),set_node_details(t),removeLoadingIndicator(regionloadWait)}function update_multiple_items(){var e=apex.region("item_details").widget().interactiveGrid("getViews","grid").model,t=apex.region("item_details").widget().interactiveGrid("getViews").grid.getSelectedRecords();if(t.length>0){0;for(const n of t)e.setValue(n,"CHANGE_COLUMN","Y"),1;save_item_detail()}}function getAssormentDetails(){var e="P"==$v("P419_CDT_SEARCH_TYPE")?$v("P419_ITEM_ASSORT"):"";return[e,"FULL"!==e?"cdt_tree":"cdtFull_tree"]}function getParentArray(e){for(var t=[],n=e;null!==n._parent;)t.push(n=n._parent);return t.reverse()}function moveNodeExpandNode(){var e,t=JSON.parse($v("P419_PREV_EXPND_NODES"));for(nodes of(e="FULL"==$v("P419_ITEM_ASSORT")&&"P"==$v("P419_CDT_SEARCH_TYPE")&&"FULL"==$v("P419_ASSORT_TYPE")?$("#cdtFull_tree"):$("#cdt_tree"),t)){var n=e.treeView("find",{depth:-1,match:function(e){return e.id==nodes}}),o=e.treeView("getNodes",n);o[0]&&getParentArray(o[0]).forEach((function(t){var n=e.treeView("getTreeNode",t);e.treeView("expand",n)}))}}function zoom_in(e,t){var n=$("#"+e),o=n.css("transform").match(g_matrixRegex),r=parseFloat(o[1]);n.css({transform:"scale("+(r+t)+")"})}function reset_zoom(e){var t=$("#"+e);t.css({transform:"scale(1)"}),t.css("cursor","auto")}function zoom_out(e,t,n){var o=$("#"+e),r=o.css("transform").match(g_matrixRegex),i=parseFloat(r[1]);console.log("p_scale_less",t,i),(i>1&&"N"==t||"Y"==t&&i>.1)&&o.css({transform:"scale("+(i-n)+")"})}function onDocumentMouseWheel(e){var t=$(e.srcElement),n="N",o=g_img_zoom_scale;(void 0!==t.attr("id")&&e.ctrlKey&&(t.attr("id").indexOf("cdtFull")>-1||t.attr("id").indexOf("cdt")>-1)&&(e.preventDefault(),t.attr("id").indexOf("cdtFull")>-1?(t=$("#cdtFull_tree"),n="Y"):t.attr("id").indexOf("cdt")>-1&&(t=$("#cdt_tree"),n="Y")),void 0!==t.closest(".a-TreeView").attr("id"))&&(t.closest(".a-TreeView").attr("id").toString().indexOf("Full")>-1?(t=$("#cdtFull_tree"),n="Y"):(t=$("#cdt_tree"),n="Y"),o=g_tree_zoom_scale);if(e.ctrlKey){e.preventDefault();var r=t.css("transform").match(g_matrixRegex);if(null!==r){var i=parseFloat(r[1]);e.deltaY<0?(t.css({transform:"scale("+(i+o)+")"}),t.css("cursor","zoom-in")):(i>1&&"N"==n||"Y"==n&&i>.1)&&(t.css({transform:"scale("+(i-o)+")"}),t.css("cursor","zoom-out"))}}else t.css("cursor","auto")}"P"==$v("P419_CDT_SEARCH_TYPE")&&(null!==document.getElementById("core_cdt_image")&&document.getElementById("core_cdt_image").addEventListener("mousewheel",onDocumentMouseWheel,!1),"Y"==$v("P419_FULL_IMG_SHOW")&&null!==document.getElementById("full_cdt_image")&&document.getElementById("full_cdt_image").addEventListener("mousewheel",onDocumentMouseWheel,!1)),console.log("document ",document.getElementById("a_Collapsible2_cdt_content")),null!==document.getElementById("cdt_tree")&&document.getElementById("cdt_tree").addEventListener("mousewheel",onDocumentMouseWheel,!1),null!==document.getElementById("cdtFull_tree")&&document.getElementById("cdtFull_tree").addEventListener("mousewheel",onDocumentMouseWheel,!1),null!==document.getElementById("AssortcdtCore")&&document.getElementById("AssortcdtCore").addEventListener("mousewheel",onDocumentMouseWheel,!1),null!==document.getElementById("AssortcdtFull")&&document.getElementById("AssortcdtFull").addEventListener("mousewheel",onDocumentMouseWheel,!1),$(document).keydown((function(e){console.log("e.keyCode",e,e.keyCode);var[t,n]=getAssormentDetails(),o=$("#"+n).treeView("getSelectedNodes");46==e.keyCode&&o.length>0&&(e.preventDefault(),"C"==$v("P419_CASE_STATUS")||"FULL"!==$v("P419_ITEM_ASSORT")&&"FULL"==$v("P419_ASSORT_TYPE")?console.log("avoid delete"):delete_node(n,t))}));