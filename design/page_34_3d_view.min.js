function render_3danimate(){try{null!=g_renderer&&requestAnimationFrame(perform3danimate)}catch(e){error_handling(e)}}function perform3danimate(){try{null!=g_renderer&&(g_renderer.render(g_scene,g_camera),requestAnimationFrame(perform3danimate))}catch(e){error_handling(e)}}function init_3d(){try{g_canvas=document.getElementById("scenecanvas"),g_renderer=new THREE.WebGLRenderer({canvas:g_canvas,antialias:!0}),g_canvas_objects.push(g_canvas)}catch(e){return void(document.getElementById("canvasholder").innerHTML="<p><b>Sorry, an error occurred:<br>"+e+"</b></p>")}create3dWorld(),g_raycaster=new THREE.Raycaster,window.addEventListener("resize",onWindowResize_3d,!1),g_tanFOV=Math.tan(Math.PI/180*g_camera.fov/2),windowHeight=window.innerHeight,windowWidth=$("#canvasholder").innerWidth(),g_initial_windowHeight=window.innerHeight,g_camera.aspect=windowWidth/windowHeight,g_camera.fov=360/Math.PI*Math.atan(g_tanFOV*(windowHeight/g_initial_windowHeight)),g_camera.updateProjectionMatrix(),g_renderer.setSize(windowWidth,windowHeight),render();const e=new OrbitControls(g_camera,g_renderer.domElement);e.enableDamping=!0,e.enabled=!0,e.enablePan=!0,e.dampingFactor=.1,e.autoRotate=!1,e.autoRotateSpeed=.2,e.keyPanSpeed=7,e.enableZoom=!0,e.zoomSpeed=1,onWindowResize_3d("",g_pog_index),g_renderer.shadowMap.enabled=!0,g_renderer.shadowMap.type=THREE.PCFSoftShadowMap,e.update()}function onWindowResize_3d(e,o){try{windowHeight=window.innerHeight,windowWidth=$("#canvasholder").innerWidth(),g_camera.aspect=windowWidth/windowHeight,g_camera.fov=360/Math.PI*Math.atan(g_tanFOV*(windowHeight/g_initial_windowHeight)),g_renderer.setSize(windowWidth,windowHeight),set_camera_z(g_camera,g_json[0].CameraX-g_json[0].CameraW/2,g_json[0].CameraY-g_json[0].CameraH/2,g_json[0].CameraW,g_json[0].CameraH,parseFloat($v("P34_CAMERA_Z")),0,0,!1,o),g_camera.updateProjectionMatrix(),render()}catch(e){error_handling(e)}}async function create_module_from_json_3d(e,o){try{var t,a,n={};g_pog_json=[],n.Action=e[o].Action,n.SubDept=e[o].SubDept,n.BackDepth=e[o].BackDepth,n.TrafficFlow=e[o].TrafficFlow,n.HorzStart=e[o].HorzStart,n.HorzSpacing=e[o].HorzSpacing,n.VertStart=e[o].VertStart,n.VertSpacing=e[o].VertSpacing,n.AllowOverlap=e[o].AllowOverlap,n.SpecialType=e[o].SpecialType,n.SpecialTypeDesc=e[o].SpecialTypeDesc,n.DisplayMeterage=e[o].DisplayMeterage,n.RPTMeterage=e[o].RPTMeterage,n.EffStartDate=e[o].EffStartDate,n.BrandGroupID=e[o].BrandGroupID,n.Remarks=e[o].Remarks,n.FixtueGeneration=e[o].FixtueGeneration,n.FixtureType=e[o].FixtureType,n.StoreSegment=e[o].StoreSegment,n.Desc7=e[o].Desc7,n.Area=e[o].Area,n.POGCode=e[o].POGCode,n.Name=e[o].Name,n.Division=e[o].Division,n.Dept=e[o].Dept,n.Type=e[o].Type,n.H=e[o].H,n.W=e[o].W,n.D=e[o].D,n.SegmentW=e[o].SegmentW,n.BaseH=e[o].BaseH,n.BaseW=e[o].BaseW,n.BaseD=e[o].BaseD,n.NotchW=e[o].NotchW,n.NotchStart=e[o].NotchStart,n.NotchSpacing=e[o].NotchSpacing,n.CameraX=e[o].CameraX,n.CameraY=e[o].CameraY,n.CameraZ=e[o].CameraZ,n.CameraW=e[o].CameraW,n.CameraH=e[o].CameraH,n.X=e[o].X,n.Y=e[o].Y,void 0===e[o].Color?n.Color=$v("P34_POG_DEFAULT_COLOR"):n.Color=e[o].Color;var r=n.CameraW/2,i=n.CameraH/2;n.BaseX=e[o].BaseX-r,n.BaseY=e[o].BaseY-i,n.BaseZ=e[o].BaseZ,n.CarPark=[],n.ModuleInfo=[],g_pog_json.push(n),t=n.W/2-r,a=n.H/2+n.BaseH,n.X=t,n.Y=a,parseFloat(n.BaseH)/2;var s=parseInt(n.Color.replace("#","0x"),16),l=new THREE.Color(s);if(n.BaseZ=n.BaseD/2,n.BaseH>0)await add_base_3d("BASE1",n.BaseW,n.BaseH,n.BaseD,l,n.BaseX,n.BaseY,n.BaseZ,o);if(e[o].ModuleInfo.length>0){var d=e[o].ModuleInfo,p=0;for(const t of d){var g={};g.SubDept=t.SubDept,g.Rotation=t.Rotation,g.HorzStart=t.HorzStart,g.HorzSpacing=t.HorzSpacing,g.VertStart=t.VertStart,g.VertSpacing=t.VertSpacing,g.AllowOverlap=t.AllowOverlap,g.LNotch=t.LNotch,g.Backboard=t.Backboard,g.RNotch=t.RNotch,g.LastCount=t.LastCount,g.SeqNo=t.SeqNo,g.Module=t.Module,g.ParentModule=t.ParentModule,g.ParentModuleIndex=t.ParentModuleIndex,g.POGModuleName=t.ModuleName,g.Remarks=t.Remarks,g.H=t.H,g.W=t.W,g.D=t.D,g.X=t.X-r,g.Y=t.Y-i,void 0===t.Color?g.Color=$v("P34_MODULE_DEFAULT_COLOR"):g.Color=t.Color,g.NotchW=t.NotchW,g.NotchStart=t.NotchStart,g.NotchSpacing=t.NotchSpacing,g.Z=0,g.ShelfInfo=[],g_pog_json[o].ModuleInfo.push(g);s=parseInt(g.Color.replace("#","0x"),16),l=new THREE.Color(s);if(void 0===t.ParentModule||null==t.ParentModule)await create_final_module_3d(t.Module,t.W,t.H,n.BackDepth,l,g.Y,g.VertStart,g.VertSpacing,g.HorzStart,g.HorzSpacing,g.X,p,o);if(e[o].ModuleInfo[p].ShelfInfo.length>0)await create_shelf_from_json_3d(p,e,t.W,"Y",r,i,n.BackDepth,o);p+=1}}return set_camera_z_3d(g_camera,n.CameraX-n.CameraW/2,n.CameraY-n.CameraH/2,n.CameraW,n.CameraH,parseFloat($v("P34_CAMERA_Z"))),render_3danimate(),render(),live_Image3D(),removeLoadingIndicator(regionloadWait),"SUCCESS"}catch(e){error_handling(e)}}async function create_shelf_from_json_3d(e,o,t,a,n,r,i,s){try{var l=0,d=0,p=0,g=0,_=0,h=0,f=0;if(o[s].ModuleInfo[e].ShelfInfo.length>0&&"N"==a&&(g_json[s].ModuleInfo[e].ShelfInfo.splice(0),$.each(o[s].ModuleInfo[e].ShelfInfo,(function(e,o){var t=g_world.getObjectById(o.SObjID);g_world.getObjectById.remove(t)}))),o[s].ModuleInfo[e].ShelfInfo.length>0&&$.each(o[s].ModuleInfo[e].ShelfInfo,(function(t,a){"BASE"!==a.ObjType&&"NOTCH"!==a.ObjType&&"DIVIDER"!==a.ObjType&&"TEXTBOX"!==a.ObjType&&(l=Math.max(l,i+a.D),o[s].ModuleInfo[e].ShelfInfo[t].ItemInfo.length>0&&$.each(a.ItemInfo,(function(e,o){l=Math.max(l,i+o.D),"ROD"==a.ObjType&&(0==a.DGap&&"E"==a.SpreadItem?o.BaseD>1&&(o.D=o.OD*o.BaseD):a.DGap>0&&"E"==a.SpreadItem&&o.BaseD>1&&(o.D=o.D+a.DGap*(o.BaseD-1)),g+=o.D,"F"==a.SpreadItem&&(h+=o.OD*o.BaseD,f+=o.BaseD))})))})),o[s].ModuleInfo[e].ShelfInfo.length>0){g_shelf_details=o[s].ModuleInfo[e].ShelfInfo;var c=0;for(const t of g_shelf_details){var m={};if(m.X=t.X-n,m.Y=t.Y-r,m.Z=t.Z,m.GrillH=t.GrillH,m.LOverhang=t.LOverhang,m.ROverhang=t.ROverhang,m.SpacerThick=t.SpacerThick,m.HorizGap=t.HorizGap,m.SpreadItem=t.SpreadItem,m.Combine=t.Combine,m.AllowAutoCrush=t.AllowAutoCrush,m.HorizSlotStart=t.HorizSlotStart,m.HorizSlotSpacing=t.HorizSlotSpacing,m.HorizStart=t.HorizStart,m.HorizSpacing=t.HorizSpacing,m.UOverHang=t.UOverHang,m.LOverHang=t.LoOverHang,m.VertiStart=t.VertiStart,m.VertiSpacing=t.VertiSpacing,m.BsktFill=t.BsktFill,m.BsktSpreadProduct=t.BsktSpreadProduct,m.SnapTo=t.SnapTo,m.BsktWallH=t.BsktWallH,m.BsktBaseH=t.BsktBaseH,m.BsktWallThickness=t.BsktWallThickness,m.DSlotStart=t.DSlotStart,m.DSlotSpacing=t.DSlotSpacing,m.DGap=t.DGap,m.FrontOverHang=t.FrontOverHang,m.BackOverHang=t.BackOverHang,m.SlotDivider=t.SlotDivider,m.AvlSpace=t.W+t.LOverhang+t.ROverhang,m.WrapText=t.WrapText,m.ReduceToFit=t.ReduceToFit,m.Shelf=t.Shelf,m.ObjType=t.ObjType,m.Desc=t.Desc,m.MaxMerch=t.MaxMerch,m.H=t.H,m.W=t.W,m.D=t.D,m.Rotation=t.Rotation,m.Slope=t.Slope,m.FStyle=t.FStyle,m.FSize=t.FSize,m.FBold=t.FBold,m.TextImg=t.TextImg,void 0===t.Color?m.Color=$v("P34_SHELF_DEFAULT_COLOR"):m.Color=t.Color,m.LiveImage=t.LiveImage,m.InputText=t.InputText,m.ItemInfo=[],g_pog_json[s].ModuleInfo[e].ShelfInfo.push(m),"NOTCH"!==t.ObjType&&"BASE"!==t.ObjType&&"DIVIDER"!==t.ObjType){var u=parseInt(m.Color.replace("#","0x"),16),E=new THREE.Color(u),I=0;if(0==l&&(l=i/2+m.D/2),void 0===g_pog_json[s].ModuleInfo[e].ParentModule||null==g_pog_json[s].ModuleInfo[e].ParentModule)if("PEGBOARD"==m.ObjType)var S=add_pegboard_3d(m.Shelf,m.W,m.H,m.D,E,m.X,m.Y,m.Z,m.VertiStart,m.VertiSpacing,m.HorizStart,m.HorizSpacing,e,s);else if("TEXTBOX"==m.ObjType){if("Y"==g_show_live_image&&""!==m.TextImg)S=add_text_box_with_image_3d(m.Shelf,"TEXTBOX",m.W,m.H,m.D,E,m.X,m.Y,0==m.Z?i/2+m.D/2:m.Z,e,m.InputText,u,m.WrapText,m.ReduceToFit,m.Color,m.Rotation,m.Slope,m.FStyle,m.FSize,m.FBold,c,s);else S=add_text_box_3d(m.Shelf,"TEXTBOX",m.W,m.H,m.D,E,m.X,m.Y,0==m.Z?i/2+m.D/2:m.Z,e,m.InputText,u,m.WrapText,m.ReduceToFit,m.Color,m.Rotation,m.Slope,m.FStyle,m.FSize,m.FBold,s);const o=g_pog_json[s].BaseX-g_pog_json[s].BaseW/2,t=g_pog_json[s].BaseX+g_pog_json[s].BaseW/2,a=g_pog_json[s].BaseY+g_pog_json[s].BaseH/2,n=g_pog_json[s].BaseY-g_pog_json[s].BaseH/2,r=m.X-m.W/2,l=m.X+m.W/2,d=m.Y+m.H/2,p=m.Y-m.H/2;r<t&&l>o&&d>n&&p<a&&m.Z<g_pog_json[s].BaseD+.1&&(g_world.getObjectById(S).position.z=g_pog_json[s].BaseD+.1,m.Z=g_pog_json[s].BaseD+.1)}else if("ROD"==m.ObjType)S=add_rod_3d(m.Shelf,"SHELF",m.W,m.H,m.D,E,m.X,m.Y,m.Z,e,s);else{"BASKET"==m.ObjType||"CHEST"==m.ObjType?"Y"==g_chest_as_pegboard&&"CHEST"==m.ObjType?(I=m.D,m.D=m.BsktBaseH,m.Z=i/2+m.BsktBaseH/2):I=m.BsktBaseH:I=m.H,"HANGINGBAR"==m.ObjType&&(m.Z=i/2,m.D=.01);S=add_shelf_3d(m.Shelf,"SHELF",m.W,I,m.D,E,m.X,m.Y,m.Z,e,m.Rotation,m.Slope,c,s)}if(o[s].ModuleInfo[e].ShelfInfo[c].ItemInfo.length>0){item_Details=o[s].ModuleInfo[e].ShelfInfo[c].ItemInfo,_=o[s].ModuleInfo[e].ShelfInfo[c].ItemInfo.length,p=0,d=0;var H=0;for(const o of item_Details){var T=g_world.getObjectById(o.ObjID);g_world.remove(T);var w={};if(w.DimT=o.DimT,w.PegID=o.PegID,w.PegSpread=o.PegSpread,w.PegPerFacing=o.PegPerFacing,w.Fixed=o.Fixed,w.CapStyle=o.CapStyle,w.Rotation=o.Rotation,w.BaseD=o.BaseD,w.CrushHoriz=o.CrushHoriz,w.CrushVert=o.CrushVert,w.CrushD=o.CrushD,w.Price=o.Price,w.Cost=o.Cost,w.RegMovement=o.RegMovement,w.AvgSales=o.AvgSales,w.ItemStatus=o.ItemStatus,w.MoveBasis=o.MoveBasis,w.CHPerc=o.CHPerc,w.CWPerc=o.CWPerc,w.CDPerc=o.CDPerc,w.ItemNesting=o.ItemNesting,w.NVal=o.NVal,w.ItemContain=o.ItemContain,w.CnVal=o.CnVal,w.IsContainer=o.IsContainer,w.BsktFactor=o.BsktFactor,w.OverHang=o.OverHang,w.VertGap=o.VertGap,w.OW=o.OW,w.OH=o.OH,w.OD=o.OD,w.Quantity=o.Quantity,w.Dragged=o.Dragged,w.SpreadItem=o.SpreadItem,w.MHorizCrushed=o.MHorizCrushed,w.MVertCrushed=o.MVertCrushed,w.MDepthCrushed=o.MDepthCrushed,w.RW=o.RW,w.RH=o.RH,w.RD=o.RD,w.SlotDivider=o.SlotDivider,w.CapCount=o.CapCount,w.X=o.X-n,w.Y=o.Y-r,w.Z=o.Z,w.ItemID=o.ItemID,w.Item=o.Item,w.W=o.W,w.H=o.H,w.D=o.D,void 0===o.Color?w.Color=$v("P34_ITEM_DFT_COLOR"):w.Color=o.Color,w.Desc=o.Desc,w.Barcode=o.Barcode,w.LocID=o.LocID,w.BHoriz=o.BHoriz,w.BVert=o.BVert,w.Orientation=o.Orientation,w.MerchStyle=o.MerchStyle,w.Supplier=o.Supplier,w.Brand=o.Brand,w.Group=o.Group,w.Dept=o.Dept,w.Class=o.Class,w.SubClass=o.SubClass,w.StdUOM=o.StdUOM,w.SizeDesc=o.SizeDesc,w.HorizGap=o.HorizGap,w.UW=o.UW,w.UH=o.UH,w.UD=o.UD,w.CW=o.CW,w.CH=o.CH,w.CD=o.CD,w.TW=o.TW,w.TH=o.TH,w.TD=o.TD,w.DW=o.DW,w.DH=o.DH,w.DD=o.DD,w.BaseD=o.BaseD,w.ImgExists=o.ImgExists,g_pog_json[s].ModuleInfo[e].ShelfInfo[c].ItemInfo.push(w),"ROD"==m.ObjType?("E"==m.SpreadItem&&0==m.DGap||"E"==m.SpreadItem&&m.DGap>0?m.DGap=(m.D-g)/(_-1):"F"==m.SpreadItem&&(m.DGap=(m.D-h)/(f-1),w.D=w.D+m.DGap*(w.BaseD-1)),"FR"!=m.SpreadItem?0==H?(d=i/2+w.D/2,p=w.D):d=d+p/2+w.D/2+m.DGap:0==H?(d=i/2+m.D-w.D/2,p=w.D):d=d-p/2-w.D/2+m.DGap,w.Z=d):"BASKET"!=m.ObjType||"BT"!=m.BsktSpreadProduct&&"LR"!=m.BsktSpreadProduct?"SHELF"==m.ObjType||"CHEST"==m.ObjType?"Y"==g_chest_as_pegboard&&"CHEST"==m.ObjType?w.Z=i/2+m.BsktBaseH+w.D/2:w.Z=i/2+m.D-w.D/2:"PALLET"==m.ObjType?w.Z=m.D-w.Z:"HANGINGBAR"==m.ObjType?w.Z=i/2+w.D/2:w.Z=i/2+w.D/2+m.D/2+m.Z:(w.D=m.D,w.Z=i/2+w.D/2),"DIVIDER"==w.Item)var R=add_items_3d(w.ItemID,w.W,w.H,w.D,w.Color,w.X,w.Y,w.Z,e,c,H,w.Rotation,s);else{if("Y"==g_show_live_image&&3!=o.MerchStyle)if("Y"==w.ImgExists){var D=g_orientation_json[g_json[s].ModuleInfo[e].ShelfInfo[c].ItemInfo[H].Orientation].split("###");R=await add_items_with_image_3d(w.ItemID,w.W,w.H,w.D,w.Color,w.X,w.Y,w.Z,e,c,H,w.BHoriz,w.BVert,w.Item,parseInt(D[0]),parseInt(D[1]),"N",w.BaseD,"",$v("P34_SHOW_ITEM_SIDE_IMAGE"),s)}else R=await add_items_prom_3d(w.ItemID,w.W,w.H,w.D,w.Color,w.X,w.Y,w.Z,e,c,H,"",s);else R=await add_items_prom_3d(w.ItemID,w.W,w.H,w.D,w.Color,w.X,w.Y,w.Z,e,c,H,"",s);g_pog_json[s].ModuleInfo[e].ShelfInfo[c].ItemInfo[H].ObjID=R}H+=1}}}c+=1}}}catch(e){error_handling(e)}}function add_base_3d(e,o,t,a,n,r,i,s,l){try{return new Promise((function(l,d){g_pog_base=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshStandardMaterial({color:n}));add_wireframe_3d(g_pog_base);g_pog_base.position.x=r,g_pog_base.position.y=i,g_pog_base.position.z=s,g_pog_base.uuid=e,g_world.add(g_pog_base),g_pog_base.castShadow=!0,render(),l("SUCCESS")}))}catch(e){error_handling(e)}}function create_final_module_3d(e,o,t,a,n,r,i,s,l,d,p,g,_){try{return new Promise((function(h,f){if(g_module=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshStandardMaterial({color:n})),s>0||d>0){var c=add_dots_to_object_3d(o-2*g_json[_].ModuleInfo[g].NotchW,t,a,i,s,l,d,g_module,"MODULE","",g);c.position.x=p,c.position.y=r,c.position.z=0,c.uuid=e,g_json[_].ModuleInfo[g].NotchW>0&&add_notches_3d("MODULE"+g+"_NOTCHES",g_json[_].ModuleInfo[g].NotchW,t,a,g_json[_].ModuleInfo[g].NotchStart,g_json[_].ModuleInfo[g].NotchSpacing,n,o,g,c,_);add_wireframe_3d(c);g_world.add(c),c.castShadow=!0,c.receiveShadow=!0,0==g?g_module_obj_array.splice(g,g+1):g_module_obj_array.splice(g,1),g_module_obj_array.push(c)}else{g_module.position.x=p,g_module.position.y=r,g_module.position.z=0,g_module.uuid=e,g_json[_].ModuleInfo[g].NotchW>0&&add_notches_3d("MODULE"+g+"_NOTCHES",g_json[_].ModuleInfo[g].NotchW,t,a,g_json[_].ModuleInfo[g].NotchStart,g_json[_].ModuleInfo[g].NotchSpacing,n,o,g,g_module,_);add_wireframe_3d(g_module);g_world.add(g_module),g_module.castShadow=!0,g_module.receiveShadow=!0,0==g?g_module_obj_array.splice(g,g+1):g_module_obj_array.splice(g,1),g_module_obj_array.push(g_module)}render(),h("SUCCESS")}))}catch(e){error_handling(e)}}function add_notches_3d(e,o,t,a,n,r,i,s,l,d){try{g_notches1=new THREE.Mesh(new THREE.BoxGeometry(o,t,.001),new THREE.MeshStandardMaterial({color:i})),g_notches2=new THREE.Mesh(new THREE.BoxGeometry(o,t,.001),new THREE.MeshStandardMaterial({color:i})),add_wireframe_3d(g_notches1),add_wireframe_3d(g_notches2);var p=0-parseFloat(o)/2,g=0-parseFloat(t)/2+parseFloat(n),_=0+parseFloat(o)/2,h=0+parseFloat(t)/2,f=g,c=[];c.push(f);for(var m=0;m<1e3&&(f+=parseFloat(r))<h;m++)c.push(f);var u=[];for(m=0;m<c.length;m++)u.push(new THREE.Vector3(p,c[m],0)),u.push(new THREE.Vector3(_,c[m],0));let a=(new THREE.BufferGeometry).setFromPoints(u);var E=new THREE.LineBasicMaterial({color:0}),I=new THREE.LineSegments(a,E),S=new THREE.LineSegments(a,E);I.position.z=.001,S.position.z=.001,g_notches1.add(I),g_notches2.add(S);var H=0-parseFloat(s)/2+parseFloat(o)/2,T=0-parseFloat(s)/2+(parseFloat(s)-parseFloat(o)/2);g_notches1.position.x=H,g_notches1.position.y=0,g_notches1.position.z=.001,g_notches2.position.x=T,g_notches2.position.y=0,g_notches2.position.z=.001,d.add(g_notches1),d.add(g_notches2),render(),g_notches1.uuid=e+1,g_notches2.uuid=e+2}catch(e){error_handling(e)}}function add_pegboard_3d(e,o,t,a,n,r,i,s,l,d,p,g,_,h){try{var f;f=parseFloat(g_json[h].ModuleInfo[_].ShelfInfo.length)-1,g_pegboard=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshStandardMaterial({color:n}));var c=add_dots_to_object_3d(o,t,a,l,d,p,g,g_pegboard,"PEGBOARD",f,_,add_pegboard_3d);c.position.x=r,c.position.y=i,c.position.z=parseFloat(s),g_pegboard.uuid=e;add_wireframe_3d(c);return g_world.add(c),c.castShadow=!0,render(),g_dblclick_opened="N","SUCESS"}catch(e){error_handling(e)}}function dcText_3d(e,o,t,a,n,r,s,l,d,p,g,_){try{const[g,_]=get_visible_size(.012,n,r,document.getElementById("scenecanvas"),g_camera);var h=o,f=document.createElement("canvas"),c=f.getContext("2d");f.width=g,f.height=_,null==a&&null===a||(c.fillStyle="#"+a.toString(16).padStart(6,"0"),c.fillRect(0,0,g,_)),c.textAlign="center",c.textBaseline="middle",c.fillStyle="#"+t.toString(16).padStart(6,"0"),c.font=p+" "+h+"px "+d;var m=c.measureText(e).width;if("Y"==l&&m>g){var u=50;for(i=50;i>=0;i--){var E=document.createElement("canvas"),I=E.getContext("2d");if(E.width=g,E.height=_,null==a&&null===a||(I.fillStyle="#"+a.toString(16).padStart(6,"0"),I.fillRect(0,0,g,_)),I.textAlign="center",I.textBaseline="middle",I.fillStyle="#"+t.toString(16).padStart(6,"0"),I.font=p+" "+i+"px "+d,I.measureText(e).width+5<=g){u=i;break}}h=u<50?u:h}null==a&&null===a||(c.fillStyle="#"+a.toString(16).padStart(6,"0"),c.fillRect(0,0,g,_)),c.textAlign="center",c.textBaseline="middle",c.fillStyle="#"+t.toString(16).padStart(6,"0"),c.font=p+" "+h+"px "+d;m=c.measureText(e).width,"Y"==s&&m>g?wrapText(c,e,g/2,h,g,25):c.fillText(e,g/2,_/2);var S=new THREE.CanvasTexture(f);S.minFilter=THREE.LinearFilter,geometry=new THREE.PlaneGeometry(n,r);var H=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:S,transparent:!0,opacity:1});return H.map.minFilter=THREE.LinearFilter,new THREE.Mesh(geometry,H)}catch(e){error_handling(e)}}function add_text_box_with_image_3d(e,o,t,a,n,r,i,s,l,d,p,g,_,h,f,c,m,u,E,I,S,H){try{var T=new Image,w=new THREE.Texture(T);T.onload=()=>{w.needsUpdate=!0},T.src="data:image/png;base64,"+g_json[H].ModuleInfo[d].ShelfInfo[S].TextImg,geometry=new THREE.PlaneGeometry(t,a);var R=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:w,transparent:!0,opacity:1}),D=new THREE.Mesh(geometry,R);0===c&&0===m||(m=m>0?0-m:-m,D.rotateY(c*Math.PI/180),0==c?D.rotateX(m/2*Math.PI/180):D.rotateX(m*Math.PI/180),D.updateMatrix()),D.uuid=e;add_wireframe_3d(D);return g_world.add(D),D.position.x=i,D.position.y=s,D.position.z=parseFloat(l)+.005,animate_pog(H),render(),D.id}catch(e){error_handling(e)}}function add_text_box_3d(e,o,t,a,n,r,i,s,l,d,p,g,_,h,f,c,m,u,E,I,S){try{if(null==hexToRgb(f))var H=parseInt("FF",16),T=parseInt("FF",16),w=parseInt("FF",16);else H=hexToRgb(f).r,T=hexToRgb(f).r,w=hexToRgb(f).g;var R;shelf_cnt=parseFloat(g_json[S].ModuleInfo[d].ShelfInfo.length)-1,R=.299*H+.587*T+.114*w>186?0:16777215,mesh=dcText_3d(p,E,R,g,t,a,_,h,u,I,E,S),(c>0||m>0||c<0||m<0)&&(m=m>0?0-m:-m,g_slope=m,mesh.rotateY(c*Math.PI/180),mesh.rotateX(m*Math.PI/180)),mesh.position.x=i,mesh.position.y=s,mesh.position.z=parseFloat(l)+.005;add_wireframe_3d(mesh);return g_world.add(mesh),mesh.castShadow=!0,console.log("mesh",mesh),animate_pog(S),render(),parseInt(mesh.id)}catch(e){error_handling(e)}}function add_rod_3d(e,o,t,a,n,r,i,s,l,d,p){try{var g=[],_=[];"undefined"!=typeof g_module_width&&""!=g_module_width||(g_module_width=parseFloat(g_json[p].ModuleInfo[d].W)),parseFloat(g_json[p].ModuleInfo[d].ShelfInfo.length)-1,g_shelf=new THREE.Mesh(new THREE.BoxGeometry(t,a,n),new THREE.MeshStandardMaterial({color:r})),g.push(0-t/2),g.push(t/2),g.push(0-t/2),g.push(t/2),_.push(0-a/2),_.push(a/2),_.push(a/2),_.push(0-a/2);var h=[];h.push(new THREE.Vector3(g[0],_[0],0)),h.push(new THREE.Vector3(g[1],_[1],0)),h.push(new THREE.Vector3(g[2],_[2],0)),h.push(new THREE.Vector3(g[3],_[3],0));let o=(new THREE.BufferGeometry).setFromPoints(h);var f=new THREE.LineBasicMaterial({color:14293787}),c=new THREE.LineSegments(o,f),m=new THREE.LineSegments(o,f);c.position.z=n/2+.001,m.position.z=n/2+.001,g_shelf.add(c),g_shelf.add(m);add_wireframe_3d(g_shelf);return g_shelf.position.x=i,g_shelf.position.y=s,g_shelf.position.z=parseFloat(l),g_shelf.uuid=e,g_world.add(g_shelf),g_shelf.castShadow=!0,render(),"SUCCESS"}catch(e){error_handling(e)}}function add_shelf_3d(e,o,t,a,n,r,i,s,l,d,p,g,_,h){try{"undefined"!=typeof g_module_width&&""!=g_module_width||(g_module_width=parseFloat(g_json[h].ModuleInfo[d].W)),parseFloat(g_json[h].ModuleInfo[d].ShelfInfo.length)-1,g_shelf=new THREE.Mesh(new THREE.BoxGeometry(t,a,n),new THREE.MeshStandardMaterial({color:r})),(p>0||g>0||p<0||g<0)&&(g=g>0?0-g:-g,g_slope=g,g_shelf.rotateY(p*Math.PI/180),g_shelf.rotateX(g*Math.PI/180));add_wireframe_3d(g_shelf);return g_shelf.position.x=i,g_shelf.position.y=g<0?s+parseFloat(g_json[h].ModuleInfo[d].ShelfInfo[_].ShelfRotateHeight)/2:g>0?s-parseFloat(g_json[h].ModuleInfo[d].ShelfInfo[_].ShelfRotateHeight)/2:s,g_shelf.position.z=parseFloat(l),g_shelf.uuid=e,g_world.add(g_shelf),g_shelf.castShadow=!0,g_shelf.receiveShadow=!0,render(),g_json[h].ModuleInfo[d].ShelfInfo[_].SObjID=g_shelf.id,"SUCCESS"}catch(e){error_handling(e)}}async function add_items_with_image_3d(e,o,t,a,n,r,i,s,l,d,g,_,h,f,c,m,u,E,I,S,H){try{return new Promise((function(c,T){var w=(ce=g_json[H].ModuleInfo[l].ShelfInfo[d].ItemInfo[g]).NVal,R=parseInt(n.replace("#","0x"),16),D=new THREE.Color(R),M=g_json[H].ModuleInfo[l].ShelfInfo[d].Rotation,C=g_json[H].ModuleInfo[l].ShelfInfo[d].Slope,B=ce.Orientation,v=g_orientation_json[B].split("###"),y=get_orientation_list(v[0]),j=ce.CapMerch,x=(ce.CapOrientaion,g_orientation_json[ce.CapOrientaion].split("###")),O=ce.CapStyle,[b,F,W,V,z,P]=get_new_orientation_dim(ce.Orientation,ce.OW,ce.OH,ce.OD);ce.CrushHoriz>0&&(b=ce.W/ce.BHoriz),ce.CrushVert>0&&(F=ce.H/ce.BVert);var G="N",N=-1,L=-1,X=-1,Y=-1,A=-1,Z=0;if(void 0!==y)for(const e of g_ItemImages)f==e.Item&&v[0]==e.Orientation&&null!==e.ItemImage?(G="Y",N=Z):f==e.Item&&y[0]==e.Orientation&&null!==e.ItemImage&&-1==L?L=Z:f==e.Item&&y[1]==e.Orientation&&null!==e.ItemImage&&-1==X?X=Z:f==e.Item&&y[2]==e.Orientation&&null!==e.ItemImage&&-1==Y&&(Y=Z),f==e.Item&&x[0]==e.Orientation&&null!==e.ItemImage&&e.MerchStyle==j&&(A=Z),Z++;else{for(const e of g_ItemImages)f==e.Item&&v[0]==e.Orientation&&null!==e.ItemImage&&(G="Y",N=Z),Z++;Z=0;for(const e of g_ItemImages){if(f==e.Item&&x[0]==e.Orientation&&null!==e.ItemImage&&e.MerchStyle==j){A=Z;break}Z++}}if("Y"==G){var U=new Image,$=new Image,q=new Image,K=new Image,Q=new Image,J=new THREE.Texture(U),ee=new THREE.Texture($),oe=new THREE.Texture(q),te=new THREE.Texture(K),ae=new THREE.Texture(Q);U.onload=()=>{J.needsUpdate=!0},$.onload=()=>{ee.needsUpdate=!0},q.onload=()=>{oe.needsUpdate=!0},K.onload=()=>{te.needsUpdate=!0},Q.onload=()=>{ae.needsUpdate=!0},U.src="data:image/png;base64,"+g_ItemImages[N].ItemImage,-1!=L&&($.src="data:image/png;base64,"+g_ItemImages[L].ItemImage),-1!=X&&(q.src="data:image/png;base64,"+g_ItemImages[X].ItemImage),-1!=Y&&(K.src="data:image/png;base64,"+g_ItemImages[Y].ItemImage),-1!=A&&(Q.src="data:image/png;base64,"+g_ItemImages[A].ItemImage);var ne=new THREE.MeshBasicMaterial({color:D});if(""!=$.src)var re=new THREE.MeshBasicMaterial({color:16777215,map:ee});else re=ne;if(""!=q.src)var ie=new THREE.MeshBasicMaterial({color:16777215,map:oe});else ie=ne;if(""!=K.src)var se=new THREE.MeshBasicMaterial({color:16777215,map:te});else se=ne;if(""!=Q.src)var le=new THREE.MeshBasicMaterial({color:16777215,map:ae});else le=ne;const f=new THREE.MeshBasicMaterial({color:16777215,map:J});if("Y"==S)var de=[re,ie,se,ne,f,ne];else de=[ne,ne,ne,ne,f,ne];var pe=new THREE.BoxGeometry(o,t,a);if(0!==nvl(M)||0!==nvl(C)){items=new THREE.Mesh(pe,de),0==w&&(J.wrapS=THREE.RepeatWrapping,J.wrapT=THREE.RepeatWrapping,90==m||270==m?J.repeat.set(h,_):J.repeat.set(_,h),90==m?m=270:270==m&&(m=90),J.rotation=m*Math.PI/180);var ge=g_world.getObjectById(g_json[H].ModuleInfo[l].ShelfInfo[d].SObjID);"N"==u&&(r=0-(g_json[H].ModuleInfo[l].ShelfInfo[d].W/2-o/2-g_json[H].ModuleInfo[l].ShelfInfo[d].ItemInfo[g].Distance),i=g_json[H].ModuleInfo[l].ShelfInfo[d].H/2+t/2,s=g_json[H].ModuleInfo[l].ShelfInfo[d].D/2-a/2),items.applyMatrix4((new THREE.Matrix4).makeTranslation(r,i,s)),g_scene.updateMatrixWorld(),items.matrixAutoUpdate=!1,items.applyMatrix4(ge.matrix)}else{J.wrapS=THREE.RepeatWrapping,J.wrapT=THREE.RepeatWrapping,ee.wrapT=THREE.RepeatWrapping,ee.wrapS=THREE.RepeatWrapping,oe.wrapT=THREE.RepeatWrapping,oe.wrapS=THREE.RepeatWrapping,te.wrapT=THREE.RepeatWrapping,te.wrapS=THREE.RepeatWrapping;var _e=ce.CapHeight;if(0==w&&"0"==O&&(90==m||270==m?J.repeat.set(h,_):(J.repeat.set(_,h),ee.repeat.set(E,h),oe.repeat.set(E,h),te.repeat.set(1,E))),90==m?m=270:270==m&&(m=90),J.rotation=m*Math.PI/180,"0"==O||void 0===O)items=new THREE.Mesh(pe,de);else{R=parseInt(n.replace("#","0x"),16),D=new THREE.Color(R);items=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshBasicMaterial({color:D}));var he=[],fe=0,ce=g_json[H].ModuleInfo[l].ShelfInfo[d].ItemInfo[g],me=h+g_json[H].ModuleInfo[l].ShelfInfo[d].ItemInfo[g].CapCount,ue=0,Ee=(g_json[H].ModuleInfo[l].ShelfInfo[d].ItemInfo[g].OD,h),Ie=a/2+1e-4*g_json[H].ModuleInfo[l].ShelfInfo[d].ItemInfo[g].CapCount;for(p=0;p<me;p++){fe=0;var Se=-1;if(0==p)ue=-ce.H/2+F,Se=-ce.H/2+F/2,Ee-=1;else if(Ee>0)Se=ue+F/2,ue+=F,Ee-=1,child_uuid="facings";else{var He=ue+_e;Se=He-_e/2,ue=He,Ie-=1e-5,child_uuid="cap"}for(k=0;k<_;k++){var Te=new THREE.MeshBasicMaterial({map:J,transparent:!0});if(p<h){var we=new THREE.BoxGeometry(b,F,.001);new_mat=Te}else{we=new THREE.BoxGeometry(b,_e,.001);-1!==A&&(ae.wrapS=THREE.RepeatWrapping,ae.wrapT=THREE.RepeatWrapping,m=x[1],90==x[1]?m=270:270==x[1]&&(m=90),ae.rotation=m*Math.PI/180),new_mat=-1!==A?le:Te}he.push(new THREE.Mesh(we,new_mat)),items.add(he[he.length-1]),0==k?(fe=-ce.W/2+b,he[he.length-1].position.x=-ce.W/2+b/2):(he[he.length-1].position.x=fe+b/2,fe+=b),he[he.length-1].position.y=Se,he[he.length-1].position.z=Ie}}}items.position.x=r,items.position.z=s,items.position.y=i}if(items.uuid=e,items.ImageExists="Y",g_world.add(items),items.castShadow=!0,add_item_borders_3d(l,d,g,items,o,t,H),I==e){g_intersected.push(items);highlightProduct(items,4,o,t,a,s)}animate_pog(H),render(),c(items.id)}else{R=parseInt(n.replace("#","0x"),16),D=new THREE.Color(R);if(items=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshStandardMaterial({color:D})),0!==M||0!==C){ge=g_world.getObjectById(g_json[H].ModuleInfo[l].ShelfInfo[d].SObjID);"N"==u&&(r=0-(g_json[H].ModuleInfo[l].ShelfInfo[d].W/2-o/2-g_json[H].ModuleInfo[l].ShelfInfo[d].ItemInfo[g].Distance),i=g_json[H].ModuleInfo[l].ShelfInfo[d].H/2+t/2,s=g_json[H].ModuleInfo[l].ShelfInfo[d].D/2-a/2),items.applyMatrix4((new THREE.Matrix4).makeTranslation(r,i,s)),g_scene.updateMatrixWorld(),items.matrixAutoUpdate=!1,items.applyMatrix4(ge.matrix)}else items.position.x=r,items.position.z=s,items.position.y=i;if(items.uuid=e,items.ImageExists="N",I==e){g_intersected.push(items);highlightProduct(items,4,o,t,a,s)}g_world.add(items),items.castShadow=!0,add_item_borders_3d(l,d,g,items,o,t,H),render(),c(items.id)}}))}catch(e){error_handling(e)}}function add_items_3d(e,o,t,a,n,r,i,s,l,d,p,g,_){try{var h=parseInt(n.replace("#","0x"),16),f=new THREE.Color(h);items=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshStandardMaterial({color:f})),0!==g&&items.rotateY(g*Math.PI/180),items.position.x=r,items.position.z=s,items.position.y=i,items.uuid=e,items.ImageExists="N";add_wireframe_3d(items);return g_world.add(items),add_item_borders_3d(l,d,p,items,o,t,_),render(),items.id}catch(e){error_handling(e)}}function add_items_prom_3d(e,o,t,a,n,r,i,s,l,d,p,g,_){try{return new Promise((function(h,f){var c=parseInt(n.replace("#","0x"),16),m=new THREE.Color(c),u=g_json[_].ModuleInfo[l].ShelfInfo[d].Rotation,E=g_json[_].ModuleInfo[l].ShelfInfo[d].Slope;if(0!==nvl(u)||0!==nvl(E)){items=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshBasicMaterial({color:m}));var I=g_world.getObjectById(g_json[_].ModuleInfo[l].ShelfInfo[d].SObjID);r=0-(g_json[_].ModuleInfo[l].ShelfInfo[d].W/2-o/2-g_json[_].ModuleInfo[l].ShelfInfo[d].ItemInfo[p].Distance),i=g_json[_].ModuleInfo[l].ShelfInfo[d].H/2+t/2,s=g_json[_].ModuleInfo[l].ShelfInfo[d].D/2-a/2,g_json[_].ModuleInfo[l].ShelfInfo[d].ItemInfo[p].RotationX=r,g_json[_].ModuleInfo[l].ShelfInfo[d].ItemInfo[p].RotationY=i,g_json[_].ModuleInfo[l].ShelfInfo[d].ItemInfo[p].RotationZ=s,items.applyMatrix4((new THREE.Matrix4).makeTranslation(r,i,s)),g_scene.updateMatrixWorld(),items.matrixAutoUpdate=!1,items.applyMatrix4(I.matrix)}else items=new THREE.Mesh(new THREE.BoxGeometry(o,t,a),new THREE.MeshStandardMaterial({color:m})),items.position.x=r,items.position.z=s,items.position.y=i;if(items.uuid=e,g==e){g_intersected.push(items);highlightProduct(items,4,o,t,a,s)}else add_wireframe_3d(items);items.ImageExists="N",g_world.add(items),items.castShadow=!0,add_item_borders_3d(l,d,p,items,o,t,_),render(),h(items.id)}))}catch(e){error_handling(e)}}function Show_Depthfacing(e,o,t,a,n,r,i){var s=[],l=[],d=[],p=0,g=0;curr_height=0;var _=g_json[i].ModuleInfo[e].ShelfInfo[o].ItemInfo[t];depth=_.D,depth_facing=_.BaseD;_.RH,_.RW,_.BHoriz;var h=_.BVert,f=0-parseFloat(r)/2,c=r,m=r;_.CapCount>0&&(c=r-2*_.CapCount*_.CapHeight,m=r-_.CapCount*_.CapHeight);var u=0+parseFloat(c)/2,E=0-parseFloat(n)/2,I=0+parseFloat(n)/2,S=0-parseFloat(depth)/2,H=0+parseFloat(depth)/2,T=0-parseFloat(n)/2,w=0+parseFloat(n)/2,R=g_json[0].ModuleInfo[e].ShelfInfo[o].ItemInfo[t].CapStyle,D=g_json[0].ModuleInfo[e].ShelfInfo[o].ItemInfo[t].CapHeight,M=g_json[0].ModuleInfo[e].ShelfInfo[o].ItemInfo[t].CapDepth,C=-1,B=-1,v=_.NVal,y=_.ItemNesting;0!==R&&(C=u,B=u+D*_.CapCount);var j=[],x=[],O=new THREE.LineBasicMaterial({color:0});if(depth_facing>1){if(""==y||void 0===y){g=depth/depth_facing;var b=S;for(F=1;F<depth_facing;F++)b+=parseFloat(g),j.push(b);for(F=0;F<j.length;F++)s.push(new THREE.Vector3(T,f,j[F])),s.push(new THREE.Vector3(T,u,j[F]));for(F=0;F<j.length;F++)d.push(new THREE.Vector3(w,f,j[F])),d.push(new THREE.Vector3(w,u,j[F]))}if(""!==v&&"D"===y){_.RD,_.BaseD,parseFloat(v),b=S,j=[];for(var F=1;F<depth_facing;F++)b+=parseFloat(v),j.push(b);for(F=0;F<j.length;F++)s.push(new THREE.Vector3(T,f,j[F])),s.push(new THREE.Vector3(T,u,j[F]));for(F=0;F<j.length;F++)d.push(new THREE.Vector3(w,f,j[F])),d.push(new THREE.Vector3(w,u,j[F]))}}var W=(new THREE.BufferGeometry).setFromPoints(s),V=(new THREE.BufferGeometry).setFromPoints(d);if((z=new THREE.LineSegments(W,O)).position.z=5e-4,a.add(z),(P=new THREE.LineSegments(V,O)).position.z=5e-4,a.add(P),s=[],d=[],h>1){for(curr_height=m/h,p=f,F=1;F<h;F++)p+=parseFloat(curr_height),l.push(p);for(F=0;F<l.length;F++)s.push(new THREE.Vector3(T,l[F],S)),s.push(new THREE.Vector3(T,l[F],H));for(F=0;F<l.length;F++)d.push(new THREE.Vector3(w,l[F],S)),d.push(new THREE.Vector3(w,l[F],H))}if(_.CapCount>0){for(curr_height=_.CapHeight,p=f+r-(_.CapCount+1)*_.CapHeight,F=0;F<_.CapCount;F++)p+=parseFloat(curr_height),l.push(p);for(F=0;F<l.length;F++)s.push(new THREE.Vector3(T,l[F],S)),s.push(new THREE.Vector3(T,l[F],H));for(F=0;F<l.length;F++)d.push(new THREE.Vector3(w,l[F],S)),d.push(new THREE.Vector3(w,l[F],H))}W=(new THREE.BufferGeometry).setFromPoints(s),V=(new THREE.BufferGeometry).setFromPoints(d);if((z=new THREE.LineSegments(W,O)).position.z=5e-4,a.add(z),(P=new THREE.LineSegments(V,O)).position.z=5e-4,a.add(P),s=[],d=[],depth_facing>1){if(""==y||void 0===y){g=depth/depth_facing;b=S;for(F=1;F<depth_facing;F++)b+=parseFloat(g),j.push(b);for(F=0;F<j.length;F++)s.push(new THREE.Vector3(E,u,j[F])),s.push(new THREE.Vector3(I,u,j[F]))}if("D"==y){_.RD,_.BaseD,parseFloat(v),b=S;for(F=1;F<depth_facing;F++)b+=parseFloat(v),j.push(b);for(F=0;F<j.length;F++)s.push(new THREE.Vector3(E,u,j[F])),s.push(new THREE.Vector3(I,u,j[F]))}}V=(new THREE.BufferGeometry).setFromPoints(s);if((P=new THREE.LineSegments(V,O)).position.z=5e-4,a.add(P),s=[],d=[],M>1){g=depth/M;b=S;for(F=1;F<M;F++)b+=parseFloat(g),x.push(b);for(F=0;F<x.length;F++)s.push(new THREE.Vector3(T,C,x[F])),s.push(new THREE.Vector3(T,B,x[F]));for(F=0;F<x.length;F++)d.push(new THREE.Vector3(w,C,x[F])),d.push(new THREE.Vector3(w,B,x[F]))}var z;W=(new THREE.BufferGeometry).setFromPoints(s),V=(new THREE.BufferGeometry).setFromPoints(d);if((z=new THREE.LineSegments(W,O)).position.z=5e-4,a.add(z),(P=new THREE.LineSegments(V,O)).position.z=5e-4,a.add(P),s=[],d=[],M>1){g=depth/M;b=S;for(F=1;F<M;F++)b+=parseFloat(g),x.push(b);for(F=0;F<x.length;F++)s.push(new THREE.Vector3(E,B,x[F])),s.push(new THREE.Vector3(I,B,x[F]))}var P;V=(new THREE.BufferGeometry).setFromPoints(s);(P=new THREE.LineSegments(V,O)).position.z=5e-4,a.add(P)}function add_item_borders_3d(e,o,t,a,n,r,s){try{var l=g_json[s].ModuleInfo[e].ShelfInfo[o].ItemInfo[t];horiz_facing=l.BHoriz,vert_facing=l.BVert;var d=l.ItemNesting,p=l.NVal,g=l.CapStyle,_=l.CapCount,[h,f,c,m,u,E]=get_new_orientation_dim(l.Orientation,l.OW,l.OH,l.OD),c=l.D,I=(l.RH,[]),S=[],H="N",T=0,w=0,R=0,D=0-parseFloat(n)/2,M=0-parseFloat(r)/2,C=0+parseFloat(n)/2,B=0+parseFloat(r)/2,v=r,y=0;l.CapCount>0&&(y=l.CapHeight,v=r-2*l.CapCount*l.CapHeight,0+parseFloat(v)/2);g_json[s].ModuleInfo[e].ShelfInfo[o].D;var j=[];if(Show_Depthfacing(e,o,t,a,n,r,s),(p>0||p<0)&&(vert_facing>1||horiz_facing>1))if(p<0&&(p*=-1,H="Y"),"H"==d){for("N"==H?(w=M+f,I.push(w)):w=M,i=1;i<vert_facing&&(w+=parseFloat(p))<B;i++)I.push(w);for(i=0;i<I.length;i++)j.push(new THREE.Vector3(D,I[i],0)),j.push(new THREE.Vector3(C,I[i],0));if(horiz_facing>1){T=n/horiz_facing;var x=D;for(i=1;i<horiz_facing&&(x+=parseFloat(T))<B;i++)S.push(x);for(i=0;i<S.length;i++)j.push(new THREE.Vector3(S[i],M,0)),j.push(new THREE.Vector3(S[i],B,0))}}else if("W"==d){for("N"==H?(w=D+h,S.push(w)):w=D,i=1;i<horiz_facing&&(w+=parseFloat(p))<C;i++)S.push(w);for(i=0;i<S.length;i++)j.push(new THREE.Vector3(S[i],M,0)),j.push(new THREE.Vector3(S[i],B,0));if(vert_facing>1){for(R=r/vert_facing,w=M,i=1;i<vert_facing&&(w+=parseFloat(R))<B;i++)I.push(w);for(i=0;i<I.length;i++)j.push(new THREE.Vector3(D,I[i],0)),j.push(new THREE.Vector3(C,I[i],0))}}else{if(vert_facing>1){for(R=(r-y)/vert_facing,w=M,i=1;i<vert_facing;i++)w+=parseFloat(R),I.push(w);for(i=0;i<I.length;i++)j.push(new THREE.Vector3(D,I[i],0)),j.push(new THREE.Vector3(C,I[i],0))}if(horiz_facing>1){T=n/horiz_facing;x=D;for(i=1;i<horiz_facing;i++)x+=parseFloat(T),S.push(x);for(i=0;i<S.length;i++)j.push(new THREE.Vector3(S[i],M,0)),j.push(new THREE.Vector3(S[i],B,0))}}else if("0"!==g){if("1"==g){for(w=M,i=1;i<=vert_facing&&(w+=parseFloat(f))<B;i++)I.push(w);for(i=1;i<_&&(w+=parseFloat(l.CapHeight))<B;i++)I.push(w);for(i=0;i<I.length;i++)j.push(new THREE.Vector3(D,I[i],0)),j.push(new THREE.Vector3(C,I[i],0))}else if("2"==g){for(w=M,i=1;i<=vert_facing;i++)w+=f,I.push(w);for(i=1;i<_&&(w+=parseFloat(l.CapHeight))<B;i++)I.push(w);for(i=0;i<I.length;i++)j.push(new THREE.Vector3(D,I[i],0)),j.push(new THREE.Vector3(C,I[i],0))}else if("3"==g){for(w=M+f,I.push(w),i=1;i<_&&(w+=parseFloat(l.CapHeight))<B;i++)I.push(w);for(i=0;i<I.length;i++)j.push(new THREE.Vector3(D,I[i],0)),j.push(new THREE.Vector3(C,I[i],0))}if(horiz_facing>1){T=n/horiz_facing;x=D;for(i=1;i<horiz_facing&&(x+=parseFloat(T))<B;i++)S.push(x);for(i=0;i<S.length;i++)j.push(new THREE.Vector3(S[i],M,0)),j.push(new THREE.Vector3(S[i],B,0))}}else{if(vert_facing>1){for(R=(r-y)/vert_facing,w=M,i=1;i<vert_facing;i++)w+=parseFloat(R),I.push(w);for(i=0;i<I.length;i++)j.push(new THREE.Vector3(D,I[i],0)),j.push(new THREE.Vector3(C,I[i],0))}if(horiz_facing>1){T=n/horiz_facing;x=D;for(i=1;i<horiz_facing;i++)x+=parseFloat(T),S.push(x);for(i=0;i<S.length;i++)j.push(new THREE.Vector3(S[i],M,0)),j.push(new THREE.Vector3(S[i],B,0))}}let F=(new THREE.BufferGeometry).setFromPoints(j);var O=new THREE.LineBasicMaterial({color:0}),b=new THREE.LineSegments(F,O);b.position.z=c/2,a.add(b)}catch(e){error_handling(e)}}function get_canvas_camera(e){try{return g_camera}catch(e){error_handling(e)}}async function get_img_indexeddb(){const e=indexedDB.open("myDatabase",2);var o,t;e.onsuccess=a=>{console.log("success 1"),o=e.result,function(){const e=o.transaction("myDatabaseStore","readwrite");e.oncomplete=e=>{console.log("complete")},e.onerror=e=>{console.log("error")};const a=e.objectStore("myDatabaseStore").get("ImageDetail");a.onsuccess=e=>{console.log("success",a.result),t=a.result,g_ItemImages=t.ImgData}}()}}async function recreate_image_items(e,o,t){try{var a=0,r=o[t].ModuleInfo;for(const f of r){if((void 0===f.ParentModule||null==f.ParentModule)&&f.ShelfInfo.length>0){j=0;for(const r of f.ShelfInfo){if("BASE"!==r.ObjType&&"NOTCH"!==r.ObjType&&"DIVIDER"!==r.ObjType&&"TEXTBOX"!==r.ObjType){n=0;for(const d of r.ItemInfo){if("DIVIDER"!==d.Item){var i=g_world.getObjectById(d.ObjID);if(g_world.remove(i),"Y"==e&&3!=d.MerchStyle)var s=g_orientation_json[g_json[t].ModuleInfo[a].ShelfInfo[j].ItemInfo[n].Orientation].split("###"),l=await add_items_with_image_3d(d.ItemID,d.W,d.H,d.D,d.Color,d.X,d.Y,d.Z,a,j,n,d.BHoriz,d.BVert,d.Item,parseInt(s[0]),parseInt(s[1]),"N",d.BaseD,"",$v("P34_SHOW_ITEM_SIDE_IMAGE"),t);else l=await add_items_prom_3d(d.ItemID,d.W,d.H,d.D,d.Color,d.X,d.Y,d.Z,a,j,n,"",t);if(o[t].ModuleInfo[a].ShelfInfo[j].ItemInfo[n].ObjID=l,"N"==e){i=g_world.getObjectById(l);"N"==d.Status?(i.BorderColour=g_status_error_color,i.Status="N",i.WireframeObj.material.color.setHex(i.BorderColour)):i.BorderColour=0}else"N"==d.Status?(i.BorderColour=g_status_error_color,i.Status="N"):void 0!==i&&(i.BorderColour=0)}n+=1}if(animate_pog(t),"SHELF"==r.ObjType)reset_top_bottom_objects(a,j,"N",t)}else if(""!==r.TextImg&&void 0!==r.TextImg&&"TEXTBOX"==r.ObjType&&null!==r.TextImg){var d=parseInt(r.Color.replace("#","0x"),16),p=new THREE.Color(d);if("#"==r.Color.charAt(1)&&"TEXTBOX"==r.ObjType)var g=null;else g=d;if("Y"==e&&""!==r.TextImg&&void 0!==r.TextImg&&null!==r.TextImg)var _=await add_text_box_with_image_3d(r.Shelf,"TEXTBOX",r.W,r.H,r.D,p,r.X,r.Y,r.Z,a,r.InputText,g,r.WrapText,r.ReduceToFit,r.Color,r.Rotation,r.Slope,r.FStyle,r.FSize,r.FBold,j,t);else{g_dblclick_objid=r.SObjID,g_shelf_index=j;_=add_text_box_3d(r.Shelf,"TEXTBOX",r.W,r.H,r.D,p,r.X,r.Y,r.Z,a,r.InputText,d,r.WrapText,r.ReduceToFit,r.Color,r.Rotation,r.Slope,r.FStyle,r.FSize,r.FBold,t)}var h=-1;$.each(o[t].ModuleInfo,(function(e,o){null!==o.ParentModule&&o.Module==r.Shelf&&(h=e)})),-1!==h&&(o[t].ModuleInfo[h].ObjID=_)}j+=1}}a+=1}}catch(e){error_handling(e)}}async function live_Image3D(){if("undefined"!=typeof g_pog_json&&g_pog_json.length>0){$("#LIVE_IMAGE").addClass("apex_disabled"),g_scene_objects=[],objects={},objects.scene=g_scene,objects.renderer=g_renderer,g_scene_objects.push(objects);await recreate_image_items(g_show_live_image,g_pog_json,g_pog_index);$("#LIVE_IMAGE").removeClass("apex_disabled")}}