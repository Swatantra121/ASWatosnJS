function add_text_box_with_image(e,o,t,n,s,i,l,f,d,a,h,r,p,g,_,x,I,c,m,S,b,u,j,w,D){logDebug("function : add_text_box_with_image; uuid : "+e+"; type : "+o+"; width : "+t+"; height : "+n+"; depth : "+s+"; color : "+i+"; x : "+l+"; y : "+f+"; z : "+d+"; p_edit_ind : "+a+"; mod_index : "+h+"; input_text : "+r+"; color_hex : "+p+"; wrap_text : "+g+"; reducetofit : "+_+"; hex_color : "+x+"; shelf_ind : "+I+"; rotation : "+c+"; slope : "+m+"; recreate : "+S+"; fontstyle : "+b+"; fontsize : "+u+"; fontbold : "+j,"S");try{return new Promise((function(o,i){var r=-1;if("Y"==a){var p=g_world.getObjectById(g_pog_json[D].ModuleInfo[h].ShelfInfo[I].SObjID);g_world.remove(p),r=I}else r=-1!==I?I:parseFloat(g_pog_json[D].ModuleInfo[h].ShelfInfo.length)-1;var g=g_pog_json[D].ModuleInfo[h].ShelfInfo[r],_=new Image,x=new THREE.Texture(_);_.onload=()=>{x.needsUpdate=!0},_.src="data:image/png;base64,"+g.TextImg,geometry=new THREE.PlaneGeometry(t,n);var S=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:x,transparent:!0,opacity:1}),b=new THREE.Mesh(geometry,S);if(0!==c||0!==m){g_rotation=c,m=m>0?0-m:-m,g_slope=m,b.position.x=g_pog_json[D].CameraX,b.position.y=f,b.position.z=s/2+g_pog_json[D].BackDepth;var u=g;b.FixelID=u.Shelf,b.POGCode=g_pog_json[D].POGCode,b.Version=g_pog_json[D].Version,b.X=wpdSetFixed(100*u.X-100*u.W/2),"Y"==u.EditNotch?b.Y=wpdSetFixed(100*u.EditNotchY):b.Y=wpdSetFixed(100*u.Y-100*u.H/2),b.Z=wpdSetFixed(100*u.Z),b.Module=g_pog_json[D].ModuleInfo[h].Module,b.W=u.W,b.H=u.H,b.D=u.D,b.Color=u.Color,b.Rotation=c,b.ItemSlope=m,b.Rotation=0!==c||0!==m?"Y":"N",b.ImageExists="Y",b.rotateY(c*Math.PI/180),0==c?b.rotateX(m/2*Math.PI/180):b.rotateX(m*Math.PI/180),g_world.add(b),b.geometry.computeBoundingBox();b.geometry.boundingBox;var j=(new THREE.Box3).setFromObject(b).getSize(new THREE.Vector3);if(g.ShelfRotateWidth=parseFloat(j.x),g.ShelfRotateHeight=parseFloat(j.y),g.ShelfRotateDepth=parseFloat(j.z),"N"==g_manual_zoom_ind){var F=get_min_max_xy(D).split("###");set_camera_z(g_camera,parseFloat(F[2]),parseFloat(F[3]),parseFloat(F[0]),parseFloat(F[1]),g_offset_z,parseFloat(F[4]),parseFloat(F[5]),!0,D)}b.position.x=l,b.position.y=f,b.position.z=s/2+g_pog_json[D].BackDepth,0!==c&&(b.quaternion.copy(g_camera.quaternion),b.lookAt(g_pog_json[D].CameraX,g_pog_json[D].CameraY,g_pog_json[D].CameraZ)),b.rotateY(c*Math.PI/180),0==c?b.rotateX(m/2*Math.PI/180):b.rotateX(m*Math.PI/180),b.updateMatrix()}else b.position.x=l,b.position.y=f,d==g_pog_json[D].BackDepth?b.position.z=.001:b.position.z=d>.0021?.0021:0==d?6e-4:d;b.uuid=e,b.FixelID=g.Shelf,b.Module=g_pog_json[D].ModuleInfo[h].Module,b.POGCode=g_pog_json[D].POGCode,b.Version=g_pog_json[D].Version,b.X=wpdSetFixed(100*g.X-100*g.W/2),"Y"==g.EditNotch?b.Y=wpdSetFixed(100*g.EditNotchY):b.Y=wpdSetFixed(100*g.Y-100*g.H/2),b.Z=wpdSetFixed(100*g.Z);var Y=add_wireframe(b,1);if(g_world.add(b),g.WFrameID=Y,b.BorderColour=0,"Y"==g_show_fixel_label){var y=g.Color;if(null==hexToRgb(y))var O=parseInt("FF",16),Z=parseInt("FF",16),M=parseInt("FF",16);else O=hexToRgb(y).r,Z=hexToRgb(y).r,M=hexToRgb(y).g;var B=getTextColor(O,Z,M),z=addlabelText(g.Shelf,10,.018,B,"center","");b.add(z),z.position.x=0-(g.W/2.4+.01),z.position.y=0,z.position.z=.005,g.LObjID=z.id}"Y"==g_show_notch_label&&show_notch_labels("Y",w,"N",D),g.SObjID=parseInt(b.id),o(b.id),logDebug("function : add_text_box_with_image","E")}))}catch(e){error_handling(e)}}function get_textbox_z(e,o,t,n,s,i,l){logDebug("function : get_textbox_z; p_module_index : "+e+"; p_shelf_index : "+o+"; x : "+t+"; y : "+n+"; width : "+s+"; height : "+i,"S");var f=t-s/2,d=t+s/2,a=n+i/2,h=n-i/2,r=g_pog_json[l].ModuleInfo,p="N",g=0;for(const e of r){if("Y"==p)break;if(void 0===e.ParentModule||null==e.ParentModule){var _=e.ShelfInfo;for(const e of _){if("Y"==p)break;if("BASE"!==e.ObjType&&"NOTCH"!==e.ObjType&&"DIVIDER"!==e.ObjType&&"TEXTBOX"!==e.ObjType)if(e.ItemInfo.length>0){var x=e.ItemInfo;for(const o of x){var I=o.X-o.W/2,c=o.X+o.W/2,m=o.Y+o.H/2,S=o.Y-o.H/2;if(f>=I&&f<c&&(a>S&&a<=m||h>=S&&h<m)||d>I&&d<=c&&(a>S&&a<=m||h>=S&&h<m)||f<I&&d>c&&(a>S&&a<=m||h>=S&&h<m)){p="Y",g=g_pog_json[l].BackDepth/2+e.D+.005;break}if(f>=I&&f&&a>m&&h<S||d>I&&d<=c&&a>m&&h<S){p="Y",g=g_pog_json[l].BackDepth/2+e.D+.005;break}1}}else{I=e.X-e.W/2,c=e.X+e.W/2,m=e.Y+e.H/2,S=e.Y-e.H/2;if(f>=I&&f<c&&(a>S&&a<=m||h>=S&&h<m)||d>I&&d<=c&&(a>S&&a<=m||h>=S&&h<m)||f<I&&d>c&&(a>S&&a<=m||h>=S&&h<m)){p="Y",g=g_pog_json[l].BackDepth/2+e.D+.005;break}if(f>=I&&f&&a>m&&h<S||d>I&&d<=c&&a>m&&h<S){p="Y",g=g_pog_json[l].BackDepth/2+e.D+.005;break}}1}}1}if("N"==p)if(g_pog_json&&g_pog_json[l]&&g_pog_json[l].ModuleInfo&&g_pog_json[l].ModuleInfo[e]&&g_pog_json[l].ModuleInfo[e].ShelfInfo&&void 0!==g_pog_json[l].ModuleInfo[e].ShelfInfo[o]){var b=g_pog_json[l].ModuleInfo[e].ShelfInfo[o];g=b.Y-b.H/2<=0?g_pog_json[l].BackDepth/2+.005+g_pog_json[l].BaseD:g_pog_json[l].BackDepth/2+.005}else g=g_pog_json&&g_pog_json[l]?g_pog_json[l].BackDepth/2+.005:.005;return logDebug("function : get_textbox_z","E"),wpdSetFixed(g)}function add_text_box(e,o,t,n,s,i,l,f,d,a,h,r,p,g,_,x,I,c,m,S,b,u,j,w,D,F="N",Y="H"){logDebug("function : add_text_box; uuid : "+e+"; type : "+o+"; width : "+t+"; height : "+n+"; depth : "+s+"; color : "+i+"; x : "+l+"; y : "+f+"; z : "+d+"; p_edit_ind : "+a+"; mod_index : "+h+"; input_text : "+r+"; color_hex : "+p+"; wrap_text : "+g+"; reducetofit : "+_+"; hex_color : "+x+"; shelf_ind : "+I+"; rotation : "+c+"; slope : "+m+"; recreate : "+S+"; fontstyle : "+b+"; fontsize : "+u+"; fontbold : "+j,"S");try{if(null==hexToRgb(x))var y=parseInt("FF",16),O=parseInt("FF",16),Z=parseInt("FF",16);else y=hexToRgb(x).r,O=hexToRgb(x).r,Z=hexToRgb(x).g;if("Y"==a){var M=g_world.getObjectById(g_pog_json[D].ModuleInfo[h].ShelfInfo[I].SObjID);g_world.remove(M),shelf_cnt=I}else shelf_cnt=-1!==I?I:parseFloat(g_pog_json[D].ModuleInfo[h].ShelfInfo.length)-1;var B=g_pog_json[D].ModuleInfo[h].ShelfInfo[shelf_cnt],z=getTextColor(y,O,Z);if(z="#000000"==z?0:16777215,mesh=dcText(r,u,z,p,t,n,g,_,b,j,u,h,shelf_cnt,w,D,F,Y),0!==c||0!==m){g_rotation=c,m=m>0?0-m:-m,g_slope=m;var T=add_wireframe(mesh,1),E=0;if("Y"==S&&"N"==a){for(const e of g_pog_json[D].ModuleInfo)null==e.ParentModule&&(E=Math.max(E,parseFloat(e.X)+e.W/2));l=E+t/2,f=g_pog_json[D].CameraY}mesh.position.x=g_pog_json[D].CameraX,mesh.position.y=f,mesh.position.z=s/2+g_pog_json[D].BackDepth,mesh.uuid=e;var H=B;mesh.FixelID=H.Shelf,mesh.POGCode=g_pog_json[D].POGCode,mesh.Version=g_pog_json[D].Version,mesh.X=wpdSetFixed(100*H.X-100*H.W/2),"Y"==H.EditNotch?mesh.Y=wpdSetFixed(100*H.EditNotchY):mesh.Y=wpdSetFixed(100*H.Y-100*H.H/2),mesh.Z=wpdSetFixed(100*H.Z),mesh.NotchNo=H.NotchNo,mesh.Desc=H.Desc,mesh.Module=g_pog_json[D].ModuleInfo[h].Module,mesh.W=H.W,mesh.H=H.H,mesh.D=H.D,mesh.Color=H.Color,mesh.Rotation=c,mesh.ItemSlope=m,mesh.Rotation=0!==c||0!==m?"Y":"N",mesh.ImageExists="N",mesh.rotateY(c*Math.PI/180),0==c?mesh.rotateX(m/2*Math.PI/180):mesh.rotateX(m*Math.PI/180),g_world.add(mesh),mesh.geometry.computeBoundingBox();mesh.geometry.boundingBox;var X=(new THREE.Box3).setFromObject(mesh).getSize(new THREE.Vector3);if(B.WFrameID=T,B.ShelfRotateWidth=parseFloat(X.x),B.ShelfRotateHeight=parseFloat(X.y),B.ShelfRotateDepth=parseFloat(X.z),"N"==g_manual_zoom_ind){var v=get_min_max_xy(D).split("###");set_camera_z(g_camera,parseFloat(v[2]),parseFloat(v[3]),parseFloat(v[0]),parseFloat(v[1]),g_offset_z,parseFloat(v[4]),parseFloat(v[5]),!0,D)}"Y"==S&&"N"==a&&(l=E+t/2,f=g_pog_json[D].CameraY),mesh.position.x=l,mesh.position.y=f,mesh.position.z=s/2+g_pog_json[D].BackDepth,0!==c&&(mesh.quaternion.copy(g_camera.quaternion),mesh.lookAt(g_pog_json[D].CameraX,g_pog_json[D].CameraY,g_pog_json[D].CameraZ)),mesh.rotateY(c*Math.PI/180),0==c?mesh.rotateX(m/2*Math.PI/180):mesh.rotateX(m*Math.PI/180),mesh.updateMatrix()}else{mesh.position.x=l,mesh.position.y=f,d==g_pog_json[D].BackDepth?mesh.position.z=.001:mesh.position.z=d>.0021?.0021:0==d?6e-4:d,mesh.FixelID=B.Shelf,mesh.Module=g_pog_json[D].ModuleInfo[h].Module,mesh.POGCode=g_pog_json[D].POGCode,mesh.Version=g_pog_json[D].Version,mesh.X=wpdSetFixed(100*B.X-100*B.W/2),"Y"==B.EditNotch?mesh.Y=wpdSetFixed(100*B.EditNotchY):mesh.Y=wpdSetFixed(100*B.Y-100*B.H/2),mesh.Z=wpdSetFixed(100*B.Z),mesh.W=B.W,mesh.H=B.H,mesh.D=B.D,mesh.Color=B.Color,mesh.Rotation=c,mesh.ItemSlope=m,mesh.Rotation=0!==c||0!==m?"Y":"N",mesh.ImageExists="N",mesh.NotchNo=B.NotchNo,mesh.Desc=B.Desc;T=add_wireframe(mesh,1);g_world.add(mesh);let e=(new THREE.BufferGeometry).setFromPoints([]);var W=new THREE.LineBasicMaterial({color:0}),N=new THREE.LineSegments(e,W);N.position.z=6e-4,mesh.add(N),B.WFrameID=T}return B.SObjID=parseInt(mesh.id),logDebug("function : add_text_box","E"),parseInt(mesh.id)}catch(e){error_handling(e)}}function textboxHit(e,o,t,n,s,i,l,f="Y"){try{var d=0;for(const m of g_pog_json[e].ModuleInfo){if(void 0===m.ParentModule||null==m.ParentModule){for(textbox of m.ShelfInfo)if("TEXTBOX"==textbox.ObjType){var a=wpdSetFixed(textbox.X-textbox.W/2),h=wpdSetFixed(textbox.X+textbox.W/2),r=wpdSetFixed(textbox.Y+textbox.H/2),p=wpdSetFixed(textbox.Y-textbox.H/2);if(!(n<a&&s<a||n>h&&s>h||i>r&&l>r||i<p&&l<p))return!0}if(o==d&&"N"==f){var g=0;for(shelf of m.ShelfInfo){if(g!==t&&"BASE"!==shelf.ObjType&&"NOTCH"!==shelf.ObjType&&"DIVIDER"!==shelf.ObjType&&"TEXTBOX"!==shelf.ObjType){var _=wpdSetFixed(shelf.Y+shelf.H/2),x=wpdSetFixed(shelf.Y-shelf.H/2),I=wpdSetFixed(shelf.X-shelf.W/2),c=wpdSetFixed(shelf.X+shelf.W/2);if(!(i>_&&l>_||i<x&&l<x)&&(n==I&&s==c||n<I&&s<I||n>c&&s>c))return!0}g++}}}d++}return!1}catch(e){error_handling(e)}}function textboxPriorityPlacing(e,o,t,n="N",s="N"){logDebug("function : textboxPriorityPlacing","S");try{const s=wpdSetFixed(e.ShelfInfo.X-e.ShelfInfo.W/2),_=wpdSetFixed(e.ShelfInfo.X+e.ShelfInfo.W/2),x=wpdSetFixed(e.ShelfInfo.Y+e.ShelfInfo.H/2),I=wpdSetFixed(e.ShelfInfo.Y-e.ShelfInfo.H/2);var i,l=[],f=[],d="N";for(const e of g_pog_json[o].ModuleInfo)if(void 0===e.ParentModule||null==e.ParentModule)for(const o of e.ShelfInfo)if("TEXTBOX"==o.ObjType&&void 0!==g_world.getObjectById(o.SObjID)){const e=wpdSetFixed(o.X-o.W/2),t=wpdSetFixed(o.X+o.W/2),n=wpdSetFixed(o.Y+o.H/2),i=wpdSetFixed(o.Y-o.H/2);s<t&&_>e&&x>i&&I<n&&l.push({shelfInfo:o,txtboxZ:o.Z,txtboxWorldZ:g_world.getObjectById(o.SObjID).position.z})}else if("NOTCH"!=o.ObjType){const e=wpdSetFixed(o.X-o.W/2),t=wpdSetFixed(o.X+o.W/2),n=wpdSetFixed(o.Y+o.H/2),i=wpdSetFixed(o.Y-o.H/2);if(s<t&&_>e&&x>i&&I<n)f.push({shelfInfo:o,shelfD:o.D,shelfZ:o.Z}),d="Y";else for(const e of o.ItemInfo){const t=wpdSetFixed(e.X-e.W/2),n=wpdSetFixed(e.X+e.W/2),i=wpdSetFixed(e.Y+e.H/2),l=wpdSetFixed(e.Y-e.H/2);s<n&&_>t&&x>l&&I<i&&0!=nvl(e.ItemID)&&f.push({shelfInfo:o,shelfD:o.D,shelfZ:o.Z})}}if("Y"==d){let o=l.filter((o=>o.shelfInfo.SObjID!==e.id));(o.length>0?Math.max(...o.map((e=>e.txtboxZ))):-1/0)>=(f.length>0?Math.max(...f.map((e=>e.shelfZ+e.shelfD/2))):-1/0)?d="N":l=[]}if("Y"==n&&"Y"==d&&"undefined"!=t&&1==l.length){const o={shelfD:"desc"};f.keySort(o);i=wpdSetFixed(f[0].shelfZ+f[0].shelfD/2)>e.ShelfInfo.Z?.001:.0021,e.position.z=i}else if("Y"!=n)if(l.length>1&&"N"==d){const o={txtboxZ:"desc",txtboxWorldZ:"desc"};if(l.keySort(o),l[0].shelfInfo.Shelf==e.FixelID&&"Y"==g_textbox_dragged){const o=g_world.getObjectById(e.id),t=Math.max(...l.map((e=>e.txtboxWorldZ))),n=e.ShelfInfo.Z,s=l.filter((o=>o.shelfInfo.SObjID!==e.id)).filter((e=>e.txtboxZ<=n)),i=s.length?Math.max(...s.map((e=>e.txtboxZ))):n;return e.ShelfInfo.Z=i+.01,o.Z=100*(i+1),o.position.z=t+1e-4,o.position.z}var a=l[0].txtboxWorldZ,h=(l[0].txtboxWorldZ,0);const n=l[0].txtboxZ;for(const o of l){const s=g_world.getObjectById(o.shelfInfo.SObjID);if(o.shelfInfo.SObjID==e.id&&"Y"!=o.shelfInfo.ManualZupdate){const t=g_world.getObjectById(o.shelfInfo.SObjID),s=o.shelfInfo.Z;let f=!1;for(const o of l)if(o.shelfInfo.SObjID!==e.id&&o.shelfInfo.Z>=s){f=!0;break}if(!f){i=t.position.z;break}t.Z=100*n+1,o.shelfInfo.Z=n+.01,t.position.z=l[0].txtboxWorldZ+1e-4,i=t.position.z;break}if(o.shelfInfo.SObjID==e.id&&"Y"==o.shelfInfo.ManualZupdate){if(s.Z=void 0===t?s.Z:100*t,o.shelfInfo.Z=void 0===t?o.shelfInfo.Z:t,f.length>0){const e={shelfD:"desc"};f.keySort(e);const o=wpdSetFixed(f[0].shelfZ+f[0].shelfD/2);a=o>t?.001+o/1e3-1e-4:.0021}s.position.z=a,i=a;var r=0;for(const e of l)r>h&&(a-=1e-4,g_world.getObjectById(e.shelfInfo.SObjID).position.z>a?g_world.getObjectById(e.shelfInfo.SObjID).position.z=a:a=g_world.getObjectById(e.shelfInfo.SObjID).position.z),r++;break}h++}}else if(void 0!==t){if(f.length>0){const o={shelfD:"desc"};f.keySort(o);i=wpdSetFixed(f[0].shelfZ+f[0].shelfD/2)>e.ShelfInfo.Z?.001:.0021}else i=.001;e.position.z=i,e.Z=100*t,e.ShelfInfo.Z=t}else if(f.length>0&&"N"==d)i=-1;else if("Y"==d){const o={shelfD:"desc"};f.keySort(o);const t=wpdSetFixed(f[0].shelfZ+f[0].shelfD/2);"Y"!=e.ShelfInfo.ManualZupdate?(e.Z=100*t+1,e.ShelfInfo.Z=t+.01,i=.0021):i=t>e.ShelfInfo.Z?.001:.0021,e.position.z=i}else e.Z=1,e.ShelfInfo.Z=.01,e.position.z=.001,i=.001;else if("Y"==n&&"Y"==e.ShelfInfo.ManualZupdate)if(l.length>1&&"N"==d){const o={txtboxZ:"desc"};if(l.keySort(o),l[0].shelfInfo.Shelf==e.FixelID){const e=g_world.getObjectById(l[0].shelfInfo.SObjID);var p=Math.max(...l.map((e=>e.txtboxWorldZ)));return e.position.z=p+1e-4,p+1e-4}h=0;for(const o of l){const t=g_world.getObjectById(o.shelfInfo.SObjID);p=Math.max(...l.map((e=>100*e.txtboxZ)));var g=Math.max(...l.map((e=>e.txtboxWorldZ)));if(o.shelfInfo.SObjID==e.id&&"Y"==o.shelfInfo.ManualZupdate){if(f.length>0){const e={shelfD:"desc"};f.keySort(e);const t=wpdSetFixed(f[0].shelfZ+f[0].shelfD/2);a=t>o.txtboxZ?.001+t/1e3-1e-4:p==o.txtboxZ?g:p>o.txtboxZ?.002:.0021}else a=p==o.txtboxZ?g:p>o.txtboxZ?g-1e-4:.0021;if(g_world.getObjectById(o.shelfInfo.SObjID),t.position.z=a,i=a,f.length>0){r=0;for(const e of l)r>h?(a-=1e-4,g_world.getObjectById(e.shelfInfo.SObjID).position.z>a?g_world.getObjectById(e.shelfInfo.SObjID).position.z=a:a=g_world.getObjectById(e.shelfInfo.SObjID).position.z):g_world.getObjectById(e.shelfInfo.SObjID).position.z<a&&(g_world.getObjectById(e.shelfInfo.SObjID).position.z=.0021),r++}break}h++}}else if("Y"==d){const o={shelfD:"desc"};f.keySort(o);i=wpdSetFixed(f[0].shelfZ+f[0].shelfD/2)>e.ShelfInfo.Z?.001:.0021,e.position.z=i}return i}catch(e){error_handling(e)}}