async function init_pdf(e,o,t,a="N",n="Y"){try{logDebug("function : init_pdf","S"),"undefined"!=typeof g_scene_pdf&&await clearThree(g_scene_pdf),"undefined"!=typeof g_renderer_pdf&&null!==g_renderer_pdf&&""!==g_renderer_pdf&&(g_renderer_pdf.forceContextLoss(),g_renderer_pdf.dispose()),g_scene_pdf={},g_camera_pdf={},g_new_canvas=document.createElement("canvas"),w=e,h=o,scale=t,g_new_canvas.width=w*scale,g_new_canvas.height=h*scale,g_renderer_pdf=new THREE.WebGLRenderer({canvas:g_new_canvas}),"Y"==n&&(g_renderer_pdf.domElement.style.imageRendering="pixelated"),g_renderer_pdf.domElement.style.width=w*scale+"px",g_renderer_pdf.domElement.style.height=h*scale+"px",g_scene_pdf=new THREE.Scene,g_camera_pdf=new THREE.PerspectiveCamera(25,g_new_canvas.width/g_new_canvas.height,.1,700),g_camera_pdf.lookAt(new THREE.Vector3(0,0,0)),"Y"==n?g_renderer_pdf.setPixelRatio(1):g_renderer_pdf.setPixelRatio(window.devicePixelRatio),g_camera_pdf.add(new THREE.PointLight(14473689,.1)),g_scene_pdf.add(g_camera_pdf),g_renderer_pdf.setClearColor(16777215),g_renderer_pdf.setSize(g_new_canvas.width,g_new_canvas.height);var _=new THREE.DirectionalLight(16777215,1);_.position.set(-1,2,4).normalize(),g_scene_pdf.add(_),g_camera_pdf.aspect=g_new_canvas.width/g_new_canvas.height,g_camera_pdf.updateProjectionMatrix(),"Y"==a&&(g_world_pdf=new THREE.Object3D,g_scene_pdf.add(g_world_pdf),g_renderer_pdf.render(g_scene_pdf,g_camera_pdf)),logDebug("function : init_pdf","E")}catch(e){error_handling(e)}}async function create_scene(e,o,t,a,n,_,i,r=0,l){logDebug("function : create_scene; p_module_index : "+e+"; new_item_label : "+o,"S");try{if(void 0===g_pog_json[l].ModuleInfo[e].ParentModule||null==g_pog_json[l].ModuleInfo[e].ParentModule){if(g_pog_json[l].BaseH>0){var d=parseInt(g_pog_json[l].ModuleInfo[e].Color.replace("#","0x"),16),s=new THREE.Color(d),g=new THREE.Mesh(new THREE.BoxGeometry(g_pog_json[l].ModuleInfo[e].W+r,g_pog_json[l].BaseH,.001),new THREE.MeshStandardMaterial({color:s}));add_wireframe(g,2);g.position.x=(g_pog_json[l].ModuleInfo[e].W+r)/2,g.position.y=g_pog_json[l].BaseH/2,g.position.z=0,g_scene_pdf.add(g);var p=g_pog_json[l].ModuleInfo[e].H/2+g_pog_json[l].BaseH}else p=g_pog_json[l].ModuleInfo[e].H/2;g_world=g_scene_objects[l].scene.children[2];var c=g_world.getObjectById(g_pog_json[l].ModuleInfo[e].MObjID),f=g_pog_json[l].ModuleInfo[e].W/2,u=c.clone(!0);if(u.material=c.material.clone(!0),g_scene_pdf.add(u),u.position.set(f,p,0),g_pog_json[l].ModuleInfo[e].ShelfInfo.length>0){j=0;for(const t of g_pog_json[l].ModuleInfo[e].ShelfInfo){if("BASE"!==t.ObjType&&"NOTCH"!==t.ObjType&&"DIVIDER"!==t.ObjType&&"Y"!==t.SplitChest){var h=g_world.getObjectById(t.SObjID),m=-1,w="N";if("TEXTBOX"==t.ObjType){if(t.W<g_pog_json[l].W&&a>1||1==a){(I=new THREE.Mesh(h.geometry,h.material)).material.transparent=!1;add_wireframe(I,12);0===t.Rotation&&0===t.Slope||(t.Slope>0?slope=0-t.Slope:slope=-t.Slope,I.rotateY(t.Rotation*Math.PI/180),0==t.Rotation?I.rotateX(slope/2*Math.PI/180):I.rotateX(slope*Math.PI/180)),w="Y",m=t.X-(g_pog_json[l].ModuleInfo[e].X-g_pog_json[l].ModuleInfo[e].W/2),void 0!==t.MergeTextbox&&"Y"==t.MergeTextbox&&(m=f)}}else if("CHEST"==t.ObjType&&"Y"==g_pogcr_pdf_chest_split){var I=new THREE.Mesh(new THREE.BoxGeometry(t.W,t.H,1e-4),new THREE.MeshStandardMaterial({color:t.Color}));add_wireframe(I,2);I.material=h.material.clone(!0),m=t.X-(g_pog_json[l].ModuleInfo[e].X-g_pog_json[l].ModuleInfo[e].W/2),w="Y"}else{I=h.clone(!0);m=t.X-(g_pog_json[l].ModuleInfo[e].X-g_pog_json[l].ModuleInfo[e].W/2),I.material=h.material.clone(!0);add_wireframe(I,4);w="Y"}if("Y"==w){g_scene_pdf.add(I);var v=m-t.W/2;g_scene_pdf.updateMatrixWorld();var b=0;b="TEXTBOX"==t.ObjType?g_world.getObjectById(t.SObjID).position.z:"PEGBOARD"==t.ObjType?.003:isShelfOnPegboard(t.X,t.Y,e,l,t,g_pog_json)?.005:g_world.getObjectById(t.SObjID).position.z,I.position.set(m,t.Y,b)}k=0,update_item_distance(e,j,l,"N");for(const a of t.ItemInfo){if(void 0!==(S=g_world.getObjectById(a.ObjID))){var M=new THREE.Mesh(S.geometry,S.material);for(const e of S.children){if("wireframe"!==e.uuid)(T=e.clone(!0)).uuid=e.uuid,"facings"==T.uuid?E=.001:"cap"==T.uuid?E-=1e-4:E="ITEM_DESC"==T.uuid?6e-4:e.position.z,T.position.z=E,M.add(T)}if(g_scene_pdf.updateMatrixWorld(),M.updateMatrixWorld(),0!==t.Rotation||0!==t.Slope){var Y=a.RotationX,x=a.RotationY,y=a.RotationZ,N=new THREE.Vector3(Y,x,y).applyMatrix4(I.matrixWorld);M.position.x=N.x,M.position.y=N.y,M.position.z=N.z,M.quaternion.copy(I.quaternion),M.updateMatrix()}else{if("PEGBOARD"==t.ObjType)var E=.016;else if(isShelfOnPegboard(t.X,t.Y,e,l,t,g_pog_json))E=.005+t.D/1e3;else E=.001+t.D/1e3;var O=-1;O="BASKET"==t.ObjType&&"BT"==t.BsktSpreadProduct?v+a.W/2:v+a.Distance+a.W/2,M.position.set(O,a.Y,E)}g_scene_pdf.add(M);add_wireframe(M,4);if(add_item_borders(e,j,k,M,a.W,a.H,a.BHoriz,l,"N"),"Y"==o)update_item_label(e,j,k,M,"Y",_,i,l,"N")}k+=1}}j+=1}}if(0!==nvl(g_pog_json[l].ModuleInfo[e].ChestInfo)&&g_pog_json[l].ModuleInfo[e].ChestInfo.length>0){j=0;for(const t of g_pog_json[l].ModuleInfo[e].ChestInfo){h=g_world.getObjectById(t.SObjID),m=-1,w="N";if("CHEST"==t.ObjType&&"Y"==g_pogcr_pdf_chest_split){I=new THREE.Mesh(new THREE.BoxGeometry(t.W,t.H,1e-4),new THREE.MeshStandardMaterial({color:t.Color})),add_wireframe(I,2);I.material=h.material.clone(!0),m=t.X-(g_pog_json[l].ModuleInfo[e].X-g_pog_json[l].ModuleInfo[e].W/2),w="Y"}if("Y"==w){g_scene_pdf.add(I);v=m-t.W/2;g_scene_pdf.updateMatrixWorld();b=0;b=5e-4,I.position.set(m,t.Y,b)}k=0,update_item_distance(e,j,l,"Y");for(const a of t.ItemInfo){var S;if(void 0!==(S=g_world.getObjectById(a.ObjID))){M=new THREE.Mesh(S.geometry,S.material);for(const e of S.children){var T;if("wireframe"!==e.uuid)(T=e.clone(!0)).uuid=e.uuid,"facings"==T.uuid?E=.001:"cap"==T.uuid?E-=1e-4:E="ITEM_DESC"==T.uuid?6e-4:e.position.z,T.position.z=E,M.add(T)}if(g_scene_pdf.updateMatrixWorld(),M.updateMatrixWorld(),0!==t.Rotation||0!==t.Slope){Y=a.RotationX,x=a.RotationY,y=a.RotationZ,N=new THREE.Vector3(Y,x,y).applyMatrix4(I.matrixWorld);M.position.x=N.x,M.position.y=N.y,M.position.z=N.z,M.quaternion.copy(I.quaternion),M.updateMatrix()}else{E=.001+t.D/1e3,O=-1;O=v+a.Distance+a.W/2,M.position.set(O,a.Y,E)}g_scene_pdf.add(M);add_wireframe(M,4);if(add_item_borders(e,j,k,M,a.W,a.H,a.BHoriz,l,"Y"),"Y"==o)update_item_label(e,j,k,M,"Y",_,i,l,"Y")}k+=1}j+=1}}null!==g_renderer_pdf&&animate_pog_pdf()}return logDebug("function : create_scene","E"),"success"}catch(e){throw error_handling(e),e}}async function merge_textboxes_pdf(e,o){try{var t=-1;for(const a of e[o].ModuleInfo)if(void 0===a.ParentModule||null==a.ParentModule)for(const e of a.ShelfInfo)"TEXTBOX"==e.ObjType&&(t=Math.max(t,e.Y));l_cnt=0,l_index_arr=[];var a=0;for(const a of e[o].ModuleInfo)if(void 0===a.ParentModule||null==a.ParentModule){var n=0;for(const _ of a.ShelfInfo)"TEXTBOX"==_.ObjType&&_.W>a.W&&_.W<e[o].W&&_.Y>=t&&(l_cnt++,l_index_arr.push(n)),n++}if(l_cnt>1){a=0;for(const d of e[o].ModuleInfo){if(void 0===d.ParentModule||null==d.ParentModule){n=0;var _="N";for(const s of e[o].ModuleInfo){if("Y"==_){_="N";break}if((void 0===s.ParentModule||null==s.ParentModule)&&a!==n){var i=0;for(const n of s.ShelfInfo){if("TEXTBOX"==n.ObjType){var r=n.X-n.W/2,l=n.X+n.W/2;if(d.X-d.W/2+d.W/3>=r&&d.X+d.W/2<=l&&n.Y>=t){n.MergeTextbox="Y",e[o].ModuleInfo[a].ShelfInfo.push(n),_="Y";break}}i++}}n++}}a++}a=0;for(const n of e[o].ModuleInfo){if(void 0===n.ParentModule||null==n.ParentModule){var d=n.X-n.W/2,s=n.X+n.W/2;i=0;for(const _ of n.ShelfInfo){if("TEXTBOX"==_.ObjType){r=_.X-_.W/2,l=_.X+_.W/2;(r>d&&r>=s||r<d&&l<=d)&&_.Y>=t&&e[o].ModuleInfo[a].ShelfInfo.splice(i,1)}i++}}a++}}return e}catch(e){throw error_handling(e),e}}async function create_pdf(e,o,t,a,n,_,i,r,l,d="Y",s,g,p,c,f,u,h,m,w,I,v="N",b="",M,j="Y",Y,x,y,N,E,O,S,T,W,P,D,R,H,X,C,F,B,z,G,L,A,k,V,J,$,U){try{logDebug("function : create_pdf; p_pog_details : "+e+"; save_pdf : "+o+"; save_pog : "+t,"S"),"Y"==d&&reset_zoom(s);var q=e.TemplateDetails.split("-"),Z="N",K="N";if(j=(j||"").trim()||"Y","Y"==q[1]&&"N"==g_show_notch_label||"Y"==q[1]&&"Y"==g_show_notch_label||"N"==q[1]&&"Y"==g_show_notch_label?show_notch_labels("Y",l,"Y",s):"N"==q[1]&&show_notch_labels("N",l,"Y",s),"Y"==q[2]&&"N"==g_show_fixel_label||"Y"==q[2]&&"Y"==g_show_fixel_label||"N"==q[2]&&"Y"==g_show_fixel_label?show_fixel_labels("Y",s):"N"==q[2]&&show_fixel_labels("N",s),add_merch("Y",s),add_merch("N",s),"Y"==q[6]&&"N"==g_show_item_desc&&"Y"==j){if("Y"==g_show_live_image){await recreate_image_items("N",c,f,u,h,m,w,I,l,s,"N","",M);Z="N"}await showHideItemDescription("Y",_,r,s)}else if("N"==q[6]&&"Y"==g_show_item_desc&&"Y"==j)await showHideItemDescription("N",_,r,s);var Q=g_show_fixel_label,ee=g_show_notch_label,oe=g_show_item_label,te=g_show_item_desc;if("Y"!=o&&"N"!==g_show_live_image||"Y"!==q[7]||"N"!==q[6]||"Y"!==j)if("Y"==g_show_live_image&&"N"==q[7]&&"Y"==j){await recreate_image_items("N",c,f,u,h,m,w,I,l,s,"N","",M);Z="N"}else"Y"==g_show_days_of_supply&&"N"==q[12]&&"Y"==g_show_live_image?(await showHideDaysOfSupplyLabel("Y","N",s,"Y","N","",M),Z=g_show_live_image):"Y"==g_show_days_of_supply&&"Y"==q[12]?(await showHideDaysOfSupplyLabel("N","N",s,"Y","N","",M),Z=g_show_live_image):Z=g_show_live_image;else{await recreate_image_items("Y",c,f,u,h,m,w,I,l,s,"N","",M);Z="Y"}""!==g_sublabel_type&&showItemSubLabel(g_sublabel_type,"Y",h,m,s),animate_pog(s),old_live_iamge="N"==g_show_item_desc?g_show_live_image:"N","Y"==q[3]&&"N"==g_show_item_label?(K="Y",show_item_labels("Y",_,i,s)):"N"==q[3]&&(K="N",show_item_labels("N",_,i,s)),await timeout(200);await set_scene(e,o,ee,Q,oe,q[4],t,q[5],K,q[6],n,te,old_live_iamge,Z,s,g,v,b,q[9],q[1],q[2],q[3],Y,x,y,_,i,u,c,l,f,r,I,N,E,O,S,T,W,P,D,R,H,X,C,F,B,z,G,L,A,k,V,J,$,U);return"SUCCESS"}catch(e){throw error_handling(e),e}}async function set_scene(e,o,t,a,n,_,i,r,l,d,s,g,p,c,f,u,h="N",m="",w,I,v,b,M,j,Y,x,y,N,E,O,S,T,W,P,D,R,H,X,C,F,B,z,G,L,A,k,V,J,$,U,q,Z,K,Q,ee,oe){logDebug("function : set_scene; p_pog_details : "+e+"; save_pdf : "+o+"; notch_label : "+t+"; fixel_label : "+a+"; item_label : "+n+"; pdf_lang : "+_+"; save_pog : "+i+"; mime_type : "+r+"; new_item_label : "+l,"S");var te=[];render(f);var ae=0,ne=.5;if("Y"==M&&(ne=parseFloat(j)),void 0!==w)var _e=w.split("###");else _e=[];reset_zoom();var ie=[];if("N"==oe&&set_pegid(f),"xlsx"==r)await save_pog_to_json([g_pog_json[f]]);var re=JSON.parse(JSON.stringify(g_pog_json));if(await get_chest_split_details(g_pogcr_pdf_chest_split,f),ie=JSON.parse(JSON.stringify(g_pog_json)),"Y"==g_textbox_merge_pdf)ie=await merge_textboxes_pdf(ie,f);var le=0,de=0;for(const e of ie[f].ModuleInfo)void 0!==e.ParentModule&&null!=e.ParentModule||de++;le=0;for(const e of ie[f].ModuleInfo){if(void 0===e.ParentModule||null==e.ParentModule){var se=Y.split(":");await init_pdf(parseInt(se[0]),parseInt(se[1]),3+(.5==ne?0:3*ne),"N","Y");try{!1;var ge=0;ae=0;if(!e.Module.includes(g_nodataModuleName)){var pe=ie[f].ModuleInfo[le].W;for(var ce of ie[f].ModuleInfo){if(e.Module,ge>le&&0==nvl(ce.ParentModule)&&ce.Module.includes(g_nodataModuleName)){var fe=g_world.getObjectById(ce.MObjID),ue=ce.H/2+g_pog_json[f].BaseH;ae=ae+ce.W+.01,pe=pe+ce.W/2+.01;var he=fe.clone(!0);he.material=fe.material.clone(!0),g_scene_pdf.add(he),he.position.set(pe,ue,0),pe+=ce.W/2,g_scene_pdf.updateMatrixWorld()}ge++}}await create_scene(le,l,d,de,c,x,y,ae,f)}catch(e){error_handling(e)}var me=get_min_max_xy_module(e,le,e.W+ae,e.H,e.X+ae,ie[f].W,de).split("###"),[we,Ie]=set_camera_z_offside(g_camera_pdf,parseFloat(me[2]),parseFloat(me[3]),parseFloat(me[0]),parseFloat(me[1]),g_offset_z,0,parseFloat(me[5]),!0,f);if(g_camera_pdf.position.x=parseFloat(me[2]),g_camera_pdf.position.y=parseFloat(me[3]),g_camera_pdf.position.z=we,null!==g_renderer_pdf&&(animate_pog_pdf(),g_renderer_pdf.render(g_scene_pdf,g_camera_pdf)),!e.Module.includes(g_nodataModuleName)){var ve=await g_new_canvas.toDataURL("image/jpeg",ne),be={};be.Module=e.Module,be.MIndex=le,be.Bay=(100*e.W).toFixed(2),be.TotalBay=(100*e.H).toFixed(2)+"*"+(100*e.W).toFixed(2),be.ImgData=ve.match(/,(.*)$/)[1],te.push(be)}}le++}var Me=0;for(const _ of te){const i="data:image/jpeg;base64,"+_.ImgData;console.log(i);const r=new Image;r.src=i,await new Promise((i=>r.onload=async function(){const l=document.createElement("canvas");l.width=r.width,l.height=r.height;if(l.getContext("2d").drawImage(r,0,0),"Y"==_e[4]){var[w,M]=cropCanvasToContent(l);ie[f].ModuleInfo[_.MIndex].ScaleToFit=M,0==Me&&(ie[f].PageBreakInit="Y"==M?"Y":"N");var j=w.toDataURL("image/jpeg",ne)}else{var[Y,M]=cropCanvasToContent(l);ie[f].ModuleInfo[_.MIndex].ScaleToFit=M;var w;j=(w=cropCanvasToContent_old(l)).toDataURL("image/jpeg",ne)}if(te[Me].ImgData=j.match(/,(.*)$/)[1],++Me==te.length){te.length>0&&(await send_to_db(g_pog_json[f].POGCode,te),te=[]);for(const e of ie[f].ModuleInfo)if(void 0===e.ParentModule||null==e.ParentModule)for(const o of e.ShelfInfo)if("TEXTBOX"==o.ObjType){var ae=g_scene_objects[f].scene.children[2].getObjectById(o.SObjID);void 0!==ae&&(ae.material.transparent=!0)}g_pog_json=re;var le=[];if("Y"==_e[3]){var de=0;for(const e of g_pog_json[f].ModuleInfo)void 0!==e.ParentModule&&null!=e.ParentModule||de++;var se=0;se=de<=5?de:parseInt(de/2),le=await create_combine_pog(se,g_show_live_image,"N",P,D,R,H,parseFloat(X),parseFloat(C),parseFloat(F),parseFloat(B),z,G,parseInt(L),A,k,V,J,$,U,q,W,E,S,N,x,T,y,O,Z,K,f,I,v,b,ne,x,y,x,T,_e[3]);for(const e of le)te.push(e)}else if("Y"==_e[0]){if("Y"==_e[1]){le=await create_combine_pog(Q,"Y","N",P,D,R,H,parseFloat(X),parseFloat(C),parseFloat(F),parseFloat(B),z,G,parseInt(L),A,k,V,J,$,U,q,W,E,S,N,x,T,y,O,Z,K,f,I,v,b,ne,x,y,x,T);for(const e of le)te.push(e)}if("N"!==_e[2]){le=await create_combine_pog(ee,"N",_e[2],P,D,R,H,parseFloat(X),parseFloat(C),parseFloat(F),parseFloat(B),z,G,parseInt(L),A,k,V,J,$,U,q,W,E,S,N,x,T,y,O,Z,K,f,I,v,b,ne,x,y,x,T);for(const e of le)te.push(e);c="N",g="N"}}else{var ge=(await get_full_canvas(f,3)).toDataURL("image/jpeg",.9),pe={Module:"POG"};pe.ImgData=ge.match(/,(.*)$/)[1],te.push(pe)}Me=0;for(const _ of te){const i="data:image/jpeg;base64,"+_.ImgData;console.log(i);const r=new Image;r.src=i,r.onload=async function(){const _=document.createElement("canvas");_.width=r.width,_.height=r.height;if(_.getContext("2d").drawImage(r,0,0),"Y"==_e[3])if("Y"==_e[4])var[i,l]=cropCanvasToContent(_),w=i.toDataURL("image/jpeg",ne);else w=(i=cropCanvasToContent_old(_)).toDataURL("image/jpeg",ne);else{var i=cropCanvasToContent_old(_);w=_.toDataURL("image/jpeg",ne)}if(te[Me].ImgData=w.match(/,(.*)$/)[1],++Me==te.length){"Y"!=_e[3]&&"Y"!=_e[0]||(animate_pog_pdf(),render(f));await send_to_db(ie[f].POGCode,te);"N"==oe?await uploadImage(0):set_pegid(ie,f),await create_item_compare(e.POGCode,e.POGVersion);var I="";if(I=ie[f].Version,"Y"==oe)apex.server.process("DOWNLOAD_PDF",{x01:e.SeqNo,x02:e.POGCode,x03:e.POGVersion,x04:e.Selection_Type,x05:e.Print_Type,x06:e.TemplateId,x07:e.SequenceId,x08:"Y",x09:"",p_clob_01:JSON.stringify(ie)},{dataType:"html"}).done((function(e){return console.log(" download_pdf end",getDateTime()),g_req_count++,removeLoadingIndicator(regionloadWait),"success"})),console.log("after download pdf");else apex.server.process("DOWNLOAD_PDF",{x01:e.SeqNo,x02:ie[f].POGCode,x03:I,x04:e.Selection_Type,x05:"P",x06:e.TemplateId,x07:"Y"==h?m:"",x08:o,x09:s,x10:$v("P25_EXISTING_DRAFT_VER"),x11:$v("P25_DEFAULT_LIVE_VERSION"),x12:$v("P25_PREV_PDF_POG_VERSION"),p_clob_01:JSON.stringify(ie[f])},{dataType:"html"}).done((function(e){g_show_fixel_label="Y"==a?"Y":"N",g_show_item_label="Y"==n?"Y":"N",g_show_notch_label="Y"==t?"Y":"N",g_show_item_desc="Y"==g?"Y":"N",null==I&&(I="");var o="f?p="+$v("pFlowId")+":"+$v("pFlowStepId")+":"+$v("pInstance")+":APPLICATION_PROCESS=OPEN_PDF:NO::AI_RANDOM_STRING,P25_OPEN_POG_CODE,P25_OPEN_POG_VERSION:"+(new Date).getTime()+","+ie[f].POGCode+","+I;try{"undefined"!=typeof regionloadWait&&"function"==typeof regionloadWait.remove&&removeLoadingIndicator(regionloadWait)}catch{console.log("no loading")}logDebug("function : Download PDF","E"),"N"==g_all_pog_flag&&window.open(o,"new data"),async function(){if("N"==p&&"Y"==c&&"N"!=u)await recreate_image_items("N",E,S,N,x,y,T,W,O,f,g_show_days_of_supply,"",g_hide_show_dos_label);else if("Y"==p&&"N"==c&&"N"!=u)await recreate_image_items("Y",E,S,N,x,y,T,W,O,f,g_show_days_of_supply,"",g_hide_show_dos_label);if("Y"==d&&"N"==g)await showHideItemDescription("N",x,T,f);else if("N"==d&&"Y"==g)await showHideItemDescription("Y",x,T,f);"Y"==g_show_notch_label?await show_notch_labels("Y",O,"Y",f):await show_notch_labels("N",O,"Y",f),"Y"==g_show_fixel_label?await show_fixel_labels("Y",f):await show_fixel_labels("N",f),"Y"==g_show_item_label?await show_item_labels("Y",x,y,f):await show_item_labels("N",x,y,f),await showItemSubLabel(g_itemSubLabel,g_itemSubLabelInd,x,y,f)}()}))}}}}i()}))}logDebug("function : set_scene","E")}function cropCanvasToContent_old(e){const o=e.getContext("2d"),t=e.width,a=e.height,n=o.getImageData(0,0,t,a).data;let _=null,i=null,r=null,l=null;for(let e=0;e<a;e++)for(let o=0;o<t;o++){const a=4*(e*t+o);255!==n[a]&&255!==n[a+1]&&255!==n[a+2]&&(null===_&&(_=e),i=e,(null===r||o<r)&&(r=o),(null===l||o>l)&&(l=o))}if(null===_)return e;const d=l-r+1;var s=l-r+40,g=i-_+40,p=t-s,c=a-g;const f=document.createElement("canvas");p>=c?(s=p=t-c,f.width=p,f.height=g):(g=c=a-p,s=l+40,f.width=s,f.height=c);const u=(f.width-d)/2,h=f.getContext("2d");return h.fillStyle="white",h.fillRect(0,0,s,g),h.drawImage(e,r,_,s,g,u,40,s,g),f}function cropCanvasToContent(e){const o=e.getContext("2d"),t=e.width,a=e.height,n=o.getImageData(0,0,t,a).data;let _=null,i=null,r=null,l=null;for(let e=0;e<a;e++)for(let o=0;o<t;o++){const a=4*(e*t+o);255===n[a]&&255===n[a+1]&&255===n[a+2]||(null===_&&(_=e),i=e,(null===r||o<r)&&(r=o),(null===l||o>l)&&(l=o))}if(null===_)return e;const d=l-r+1,s=i-_+1,g=parseFloat((s/d).toFixed(1))>=1.2?"Y":"N";let p=d,c=s;const f=Math.floor((p-d)/2),u=Math.floor((c-s)/2),h=document.createElement("canvas");h.width=p,h.height=c;const m=h.getContext("2d");return m.fillStyle="white",m.fillRect(0,0,p,c),m.drawImage(e,r,_,d,s,f,u,d,s),[h,g]}async function create_combine_pog(e,o,t,a,n,_,i,r,l,d,s,g,p,c,f,u,h,m,w,I,v,b,M,j,Y,x,y,N,E,O,S,T,W,P,D,R,H,X,C,F,B="N"){try{var z=g_show_live_image,G=g_show_item_desc,L=[],A=0,k=0,V=0,J=[],$=0,U=0,q=0,Z="",K=0;if("Y"==t||"IDVURPCO"==t||"IFEC"==t){await recreate_image_items("N",M,j,Y,x,N,y,b,E,T,"N","N,0.018",[]);await showHideItemDescription("Y",C,F,T);render(T)}else"N"==g_show_live_image&&"Y"==o&&await recreate_image_items("Y",M,j,Y,x,N,y,b,E,T,"N","N,0.018",[]);g_world=g_scene_objects[T].scene.children[2],animate_pog(T);var Q=JSON.parse(JSON.stringify(g_pog_json)),ee=JSON.parse(JSON.stringify(g_pog_json)),oe=JSON.parse(JSON.stringify([g_pog_json[T]]));console.log("old_pogjson[0].ModuleInfo",ee[0].ModuleInfo),"Y"==o?(g_show_live_image="Y",g_show_item_desc="N"):"Y"!=t&&"IDVURPCO"!=t&&"IFEC"!=t||(g_temp_desc="IDVURPCO"==t||"IFEC"==t?t:"N",g_show_live_image="N",g_show_item_desc="Y"),g_show_notch_label="Y"==W?"Y":"N",g_show_fixel_label="Y"==P?"Y":"N",g_show_item_label="Y"==D?"Y":"N";var te=[],ae=0;for(const e of ee[T].ModuleInfo){if((void 0===e.ParentModule||null==e.ParentModule)&&(K++,$+=e.W,U=Math.max(U,e.H),q=Math.max(q,e.D),"Y"==g_pogcr_pdf_chest_split)){var ne=0,_e=wpdSetFixed(e.X-e.W/2),ie=wpdSetFixed(e.X+e.W/2);for(const o of e.ShelfInfo){if("CHEST"==o.ObjType){var re=wpdSetFixed(o.X-o.W/2),le=wpdSetFixed(o.X+o.W/2);(_e>re&&ie<le||_e>=re&&ie<le||_e<re&&ie<le&&ie>re||_e>re&&ie>le&&_e<le)&&(o.MIndex=ae,o.SIndex=ne,te.push(o),oe[0].ModuleInfo[ae].ShelfInfo.splice(ne,1),g_pog_json[T].ModuleInfo[ae].ShelfInfo.splice(ne,1))}ne++}}ae++}if("Y"==g_pogcr_pdf_chest_split){for(chest of te){var de="N",se=wpdSetFixed(chest.X-chest.W/2),ge=wpdSetFixed(chest.X+chest.W/2),pe=chest.ItemInfo,ce=0;for(const e of oe[0].ModuleInfo){if(void 0===e.ParentModule||null==e.ParentModule){var fe=wpdSetFixed(e.X-e.W/2),ue=wpdSetFixed(e.X+e.W/2),he=JSON.parse(JSON.stringify(chest));fe>=se&&ue<=ge?(de="Y",he.W=e.W,he.X=e.X):fe<=se&&ue<=ge&&ue>se?(de="Y",he.W=wpdSetFixed(ue-se),he.X=wpdSetFixed(se+he.W/2)):fe>=se&&ue>=ge&&fe<ge&&(de="Y",he.W=wpdSetFixed(ge-fe),he.X=wpdSetFixed(fe+he.W/2));var me=[],we=wpdSetFixed(he.X-he.W/2),Ie=wpdSetFixed(he.X+he.W/2);for(items of(module_no=chest.MIndex+1,pe))items.X>=we&&items.X<=Ie&&(items.ModuleNo=module_no,me.push(items));"Y"==de&&(he.ItemInfo=me,oe[0].ModuleInfo[ce].ShelfInfo.push(he),g_pog_json[T].ModuleInfo[ce].ShelfInfo.push(he),de="N")}ce++}0}}var ve=0,be=(A=0,0),Me=0;for(const o of oe[0].ModuleInfo){if(void 0===o.ParentModule||null==o.ParentModule){if(o.MIndex=A,L.push(JSON.parse(JSON.stringify(o))),k++,V+=o.W,console.log("next_mod",k,e),k==e||K==be+1){Me++;var je=0,Ye=0;for(obj_mod of(await init_pdf(window.innerWidth,window.innerHeight,2,"Y","N"),L)){try{g_world=g_scene_objects[T].scene.children[2],console.log("combine loop",g_world);var xe=await clone_combine_pog(obj_mod.MIndex,je,g_show_item_label,H,X,T,Ye,V);console.log("returnval",xe,g_renderer_pdf)}catch(e){throw console.log("error",e),e}Ye+=obj_mod.W,Z="",je++}await timeout(200);for(const e of L)e.W,Z=""==Z?(100*e.W).toFixed(2):Z+"|"+(100*e.W).toFixed(2);for(const e of g_pog_json[T].ModuleInfo)if(void 0===e.ParentModule||null==e.ParentModule)for(const o of e.ShelfInfo)if("TEXTBOX"==o.ObjType){var ye=g_world.getObjectById(o.SObjID);void 0!==ye&&(ye.material.transparent=!1)}k=0;var Ne=[];(Ee={}).W=V,Ee.H=g_pog_json[T].H,Ne.push(Ee),Ne[0].ModuleInfo=L;$=0;Me>1&&($=ve),ve+=V,V=0;var Ee,Oe=(Ee=get_min_max_xy_combine(Ne,$)).split("###");set_camera_z(g_camera_pdf,parseFloat(Oe[2]),parseFloat(Oe[3]),parseFloat(Oe[0]),parseFloat(Oe[1]),g_offset_z,parseFloat(Oe[4]),parseFloat(Oe[5]),!0,0),console.log("combine g_renderer_pdf",g_renderer_pdf,g_scene_pdf,g_camera_pdf),null!==g_renderer_pdf&&g_renderer_pdf.render(g_scene_pdf,g_camera_pdf),animate_pog_pdf(),console.log("inside",oe,L,g_camera_pdf,g_scene_pdf.children.length,g_scene_pdf),L=[];var Se=g_new_canvas.toDataURL("image/jpeg",R);console.log(" after  base64 ",getDateTime());var Te={Module:"COMBINE"};Te.Bay=Z,Z="",Te.ImgData=Se.match(/,(.*)$/)[1],J.push(Te),"Y"==B&&K%2!=0&&K<=be+e+2&&(e+=1)}be++}A++}return g_temp_desc="N",g_show_live_image=z,g_show_item_desc=G,g_pog_json=Q,render(T),J}catch(e){throw console.log("error",e),error_handling(e),e}}async function clone_combine_pog(e,o,t,a,n,_,i,r){try{if(logDebug("function : create_scene; p_module_index : "+e+"; new_item_label : "+t,"S"),void 0===g_pog_json[_].ModuleInfo[e].ParentModule||null==g_pog_json[_].ModuleInfo[e].ParentModule){var l;if(g_pog_json[_].BaseH>0){var d=parseInt(g_pog_json[_].ModuleInfo[e].Color.replace("#","0x"),16),s=new THREE.Color(d),g=new THREE.Mesh(new THREE.BoxGeometry(r,g_pog_json[_].BaseH,.001),new THREE.MeshStandardMaterial({color:s}));add_wireframe(g,2);g.position.x=r/2,g.position.y=g_pog_json[_].BaseH/2,g.position.z=0,g_scene_pdf.add(g);var p=g_pog_json[_].ModuleInfo[e].H/2+g_pog_json[_].BaseH}else p=g_pog_json[_].ModuleInfo[e].H/2;if(0==o)var c=g_pog_json[_].ModuleInfo[e].W/2;else c=i+g_pog_json[_].ModuleInfo[e].W/2;l=c-g_pog_json[_].ModuleInfo[e].W/2;var f=g_world.getObjectById(g_pog_json[_].ModuleInfo[e].MObjID),u=f.clone(!0);for(objects of(u.material=f.material.clone(!0),g_scene_pdf.add(u),u.position.set(c,p,0),console.log("module ",u,u.children),u.children))console.log("objects",objects.uuid,objects.position);if(g_pog_json[_].ModuleInfo[e].ShelfInfo.length>0){j=0;for(const o of g_pog_json[_].ModuleInfo[e].ShelfInfo){if("BASE"!==o.ObjType&&"NOTCH"!==o.ObjType&&"DIVIDER"!==o.ObjType){var h=g_world.getObjectById(o.SObjID),m=-1,w="N";if("TEXTBOX"==o.ObjType){(I=new THREE.Mesh(h.geometry,h.material)).material.transparent=!1;add_wireframe(I,12);0===o.Rotation&&0===o.Slope||(o.Slope>0?slope=0-o.Slope:slope=-o.Slope,I.rotateY(o.Rotation*Math.PI/180),0==o.Rotation?I.rotateX(slope/2*Math.PI/180):I.rotateX(slope*Math.PI/180)),w="Y",m=e>0?l+(o.X-(g_pog_json[_].ModuleInfo[e].X-g_pog_json[_].ModuleInfo[e].W/2)):o.X}else if("CHEST"==o.ObjType&&"Y"==g_pogcr_pdf_chest_split){var I=new THREE.Mesh(new THREE.BoxGeometry(o.W,o.H,1e-4),new THREE.MeshStandardMaterial({color:o.Color}));add_wireframe(I,2);I.material=h.material.clone(!0),m=e>0?l+(o.X-(g_pog_json[_].ModuleInfo[e].X-g_pog_json[_].ModuleInfo[e].W/2)):o.X,w="Y"}else{I=h.clone(!0);m=e>0?l+(o.X-(g_pog_json[_].ModuleInfo[e].X-g_pog_json[_].ModuleInfo[e].W/2)):o.X,I.material=h.material.clone(!0);add_wireframe(I,4);w="Y"}if("Y"==w){g_scene_pdf.add(I);var v=m-o.W/2;g_scene_pdf.updateMatrixWorld();var b=0;b="TEXTBOX"==o.ObjType?g_world.getObjectById(o.SObjID).position.z+.004:"PEGBOARD"==o.ObjType?.003:isShelfOnPegboard(o.X,o.Y,e,_,o,g_pog_json)?.005:5e-4,I.position.set(m,o.Y,b),console.log("new_shelf ",o.ObjType,o.Shelf,I,m,o.Y,b)}k=0,update_item_distance(e,j,_,"N");for(const i of o.ItemInfo){var M=g_world.getObjectById(i.ObjID);if(void 0!==M){var Y=new THREE.Mesh(M.geometry,M.material);for(const e of M.children)if("wireframe"!==e.uuid){var x=e.clone(!0);x.uuid=e.uuid,"facings"==x.uuid?S=.001:"cap"==x.uuid?S-=1e-4:S="ITEM_DESC"==x.uuid?b:e.position.z,x.position.z=S,Y.add(x)}if(g_scene_pdf.updateMatrixWorld(),Y.updateMatrixWorld(),0!==o.Rotation||0!==o.Slope){var y=i.RotationX,N=i.RotationY,E=i.RotationZ,O=new THREE.Vector3(y,N,E).applyMatrix4(I.matrixWorld);Y.position.x=O.x,Y.position.y=O.y,Y.position.z=O.z,Y.quaternion.copy(I.quaternion),Y.updateMatrix()}else{if("PEGBOARD"==o.ObjType)var S=.016;else S=.005+o.D/1e3;var T=-1;T="BASKET"==o.ObjType&&"BT"==o.BsktSpreadProduct?v+i.W/2:v+i.Distance+i.W/2,Y.position.set(T,i.Y,S)}g_scene_pdf.add(Y);add_wireframe(Y,4);if(add_item_borders(e,j,k,Y,i.W,i.H,i.BHoriz,_,"N"),"Y"==t)update_item_label(e,j,k,Y,"Y",a,n,_,"N")}k+=1}}j+=1}}null!==g_renderer_pdf&&animate_pog_pdf()}return logDebug("function : create_scene","E"),"success"}catch(e){throw error_handling(e),e}}function download_pog_pdf(e,o){logDebug("function : download_pog_pdf","S");try{var t="f?p="+$v("pFlowId")+":"+$v("pFlowStepId")+":"+$v("pInstance")+":APPLICATION_PROCESS=DOWNLOAD_POG_PDF:NO::AI_RANDOM_STRING,AI_POG_CODE,AI_POG_VERSION:"+(new Date).getTime()+","+e+","+o;const a=document.createElement("a");a.href=t,a.download="",document.body.appendChild(a),a.click(),document.body.removeChild(a),logDebug("function : download_pog_pdf","E")}catch(e){error_handling(e),removeLoadingIndicator(regionloadWait)}}async function get_full_canvas(e,o){try{var t=document.getElementById("t_Header"),a=document.getElementById("top_bar"),n=document.getElementById("t_Body_nav"),_=document.getElementById("side_bar"),i=window.devicePixelRatio,r=null!==t?t.offsetHeight*i:0,l=null!==a?a.offsetHeight*i:0,d=null!==n?n.offsetWidth*i:0,s=null!==_?_.offsetWidth*i:0,g=document.createElement("canvas");g_windowHeight=window.innerHeight-(r+l),windowWidth=window.innerWidth-(d+s),g.width=windowWidth*o,g.height=g_windowHeight*o,g_camera=g_scene_objects[e].scene.children[0],g_scene_objects[e].scene.children[0].aspect=g.width/g.height,g_scene_objects[e].scene.children[0].updateProjectionMatrix();var p=get_min_max_xy(e).split("###");set_camera_z(g_camera,parseFloat(p[2]),parseFloat(p[3]),parseFloat(p[0]),parseFloat(p[1]),g_offset_z,parseFloat(p[4]),parseFloat(p[5]),!0,e);var c=g.getContext("2d");c.imageSmoothingEnabled=!0,g_renderer.setPixelRatio(window.devicePixelRatio);var f=g.width,u=g.height;return g_renderer.setSize(f,u),g_renderer.render(g_scene_objects[e].scene,g_scene_objects[e].scene.children[0]),c.drawImage(g_renderer.domElement,0,0,f,u),g_scene_objects[e].scene.children[0].aspect=g_canvas_objects[e].width/g_canvas_objects[e].height,g_scene_objects[e].scene.children[0].updateProjectionMatrix(),g}catch(e){throw error_handling(e),e}}