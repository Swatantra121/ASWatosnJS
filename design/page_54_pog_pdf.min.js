var g_req_count,l_pog_details=[],g_item_vertical_text_display=$v("P54_ITEM_CODE_VERT_ALN"),g_item_text_center_align=$v("P54_ITEM_CODE_CTR_ALN"),g_pogcr_enhance_textbox_fontsize=$v("P54_POGCR_ENHANCE_TEXTBOX_FONTSIZE");async function createWorld_batch(){try{"undefined"!=typeof g_scene&&await clearThree(g_scene),g_scene={},g_camera={},g_world={},"undefined"!=typeof g_renderer&&null!==g_renderer&&""!==g_renderer&&g_renderer.dispose(),g_windowHeight=window.innerHeight,windowWidth=window.innerWidth,g_initial_windowHeight=window.innerHeight,g_scene=new THREE.Scene,g_camera=new THREE.PerspectiveCamera(25,g_canvas.width/2/g_canvas.height,.1,700),g_camera.lookAt(new THREE.Vector3(0,0,0)),g_camera.add(new THREE.PointLight(16777215,.2)),g_tanFOV=Math.tan(Math.PI/180*g_camera.fov/2),g_camera.aspect=g_canvas.width/2/g_canvas.height,g_camera.fov=360/Math.PI*Math.atan(g_tanFOV*(g_windowHeight/g_initial_windowHeight)),g_camera.updateProjectionMatrix(),g_scene.add(g_camera),console.log("createWorld_batch ",g_canvas,g_renderer),g_renderer.setPixelRatio(window.devicePixelRatio),g_renderer.setClearColor(16777215);var e=new THREE.DirectionalLight(16777215,1);e.position.set(-1,2,4).normalize(),g_scene.add(e),g_world=new THREE.Object3D,g_scene.add(g_world),g_targetForDragging=new THREE.Mesh(new THREE.BoxGeometry(100,100,.01),new THREE.MeshBasicMaterial),g_targetForDragging.material.visible=!1,g_targetForDragging.material.transparent=!0,g_targetForDragging.material.opacity=.1,g_targetForDragging.uuid="drag_object",g_renderer.clear(),g_renderer.render(g_scene,g_camera)}catch(e){throw error_handling(e),e}}async function init(){try{g_select_zoom_arr=[],g_pogjson_backup=[],g_multi_shelf_arr=[],g_temp_cut_arr=[],g_errored_items=[],g_mod_block_list=[],g_temp_image_arr=[],g_lines=[],g_ItemImages=void 0,g_ItemImages=[],g_deletedItems=[],g_cutaway_cam_detail=[],g_carpark_items=[],g_cut_loc_arr=[],g_undo_obj_arr=[],g_undo_supp_obj_arr=[],g_redo_supp_obj_arr=[],g_undo_details=[],g_delete_details=[],g_undo_all_obj_arr=[],g_cut_support_obj_arr=[],g_multi_drag_shelf_arr=[],g_multi_drag_item_arr=[],g_cut_copy_arr=[],g_redo_all_obj_arr=[],g_redo_final_obj_arr=[],g_scene_objects_backup=[],g_drag_items_arr=[],g_allUndoObjectsInfo=[],g_dup_mod_list=[],g_pog_json_data=[],g_undo_final_obj_arr=[],g_module_obj_array=[],g_pogBackup=void 0,g_pogBackup=[],g_intersected=[],g_delete_item_json=[],g_combinedShelfs=[],g_combineItemModf=[],g_seqArr=[],g_seqArrDtl={},g_renum_json=[],g_multi_pog_json=void 0,g_multi_pog_json=[],g_scene_objects=[],g_canvas_objects=[],g_json=void 0,g_json=[],g_pog_json=void 0,g_pog_json=[],g_pog_list=[],g_status_bar=[],g_shelf_details=[],g_color_arr=[],g_highlightArr=[],g_all_pog_flag="Y",g_canvas_region=document.getElementById("drawing_region"),selection=document.getElementById("selection"),g_canvas_objects.push(g_canvas),createWorld_batch(),render(),multiselect="N",ctrl_select="N",window.addEventListener("resize",onWindowResize,!1),onWindowResize("F")}catch(e){return void(document.getElementById("canvas-holder").innerHTML="<p><b>Sorry, an error occurred:<br>"+e+"</b></p>")}}function onWindowResize(e){try{g_windowHeight=window.innerHeight,windowWidth=window.innerWidth,g_camera.aspect=windowWidth/g_windowHeight,g_camera.fov=360/Math.PI*Math.atan(g_tanFOV*(g_windowHeight/g_initial_windowHeight)),g_renderer.setSize(windowWidth,g_windowHeight),g_camera.updateProjectionMatrix(),g_renderer.render(g_scene,g_camera)}catch(e){error_handling(e)}}async function create_module_from_json(e,_,o,t,a,r,n,g,i){try{console.log(e),console.log(_,o,t,a,r,n,g,i),g_pog_json=e,await get_all_images(g),g_show_live_image="Y",g_pog_json=[],g_json=e,await create_module_from_json_lib(e,_,o,t,a,r,n,$v("P54_VDATE"),$v("P54_POG_DEFAULT_COLOR"),$v("P54_MODULE_DEFAULT_COLOR"),null,!1,"N",null,$v("P54_POGCR_DFT_SPREAD_PRODUCT"),parseFloat($v("P54_PEGBOARD_DFT_HORZ_SPC")),parseFloat($v("P54_PEGBOARD_DFT_VERT_SPC")),parseFloat($v("P54_BASKET_WALL_THICK")),parseFloat($v("P54_CHEST_WALL_THICK")),$v("P54_POGCR_PEG_ITEM_AUTO_PLACE"),$v("P54_POGCR_DEFAULT_WRAP_TEXT"),parseInt($v("P54_POGCR_TEXT_DEFAULT_SIZE")),$v("P54_POG_TEXTBOX_DEFAULT_COLOR"),$v("P54_SHELF_DEFAULT_COLOR"),$v("P54_DIV_COLOR"),$v("P54_SLOT_DIVIDER"),$v("P54_SLOT_ORIENTATION"),$v("P54_DIVIDER_FIXED"),$v("P54_ITEM_DFT_COLOR"),$v("P54_POGCR_DELIST_ITEM_DFT_COLOR"),"Y",null,3,$v("P54_MERCH_STYLE"),$v("P54_POGCR_LOAD_IMG_FROM"),$v("P54_BU_ID"),$v("P54_POGCR_DELIST_ITEM_DFT_COLOR"),$v("P54_POGCR_ITEM_NUM_LBL_COLOR"),$v("P54_POGCR_DISPLAY_ITEM_INFO"),$v("P54_POGCR_ITEM_NUM_LBL_COLOR"),$v("P54_POGCR_ITEM_NUM_LABEL_POS"),$v("P54_NOTCH_HEAD"),"N",$v("P54_POGCR_DFT_BASKET_FILL"),$v("P54_POGCR_DFT_BASKET_SPREAD"),g_scene_objects[g].scene.children[0],g,g,$v("P54_POGCR_NOTCH_START_VALUE"),$v("P54_POGCR_MANUAL_CRUSH_ITEM"),"Y"),animate_pog(g),g_module_obj_array=[],g_show_live_image="N",g_show_item_desc="N",g_show_fixel_label="N",g_show_item_label="N",g_show_notch_label="N";var s=0;for(const e of g_pog_json[g].ModuleInfo){if(void 0===e.ParentModule||null==e.ParentModule){var d=0;for(const _ of e.ShelfInfo){if("TEXTBOX"==_.ObjType){var c=g_world.getObjectById(g_pog_json[g].ModuleInfo[s].ShelfInfo[d].SObjID);c.ShelfInfo=g_pog_json[g].ModuleInfo[s].ShelfInfo[d],textboxPriorityPlacing(c,g,g_pog_json[g].ModuleInfo[s].ShelfInfo[d].Z)}d++}}s++}var l=i.TemplateDetails.split("-");console.log("FontSize",$v("P54_POGCR_DEFAULT_WRAP_TEXT"),$v("P54_POGCR_TEXT_DEFAULT_SIZE"));await create_pdf(i,"Y","N",g_scene_objects[g].scene.children[0],"E",$v("P54_POGCR_ITEM_NUM_LABEL_COLOR"),$v("P54_POGCR_ITEM_NUM_LABEL_POS"),$v("P54_POGCR_DISPLAY_ITEM_INFO"),$v("P54_NOTCH_HEAD"),"N",g,"Y",g_all_pog_flag,$v("P54_MERCH_STYLE"),$v("P54_POGCR_LOAD_IMG_FROM"),$v("P54_BU_ID"),$v("P54_POGCR_ITEM_NUM_LBL_COLOR"),$v("P54_POGCR_ITEM_NUM_LABEL_POS"),$v("P54_POGCR_DISPLAY_ITEM_INFO"),$v("P54_POGCR_DELIST_ITEM_DFT_COL"),"N","",[],l[7],$v("P54_POGCR_ENHANCE_PDF_IMG"),$v("P54_POGCR_PDF_IMG_ENHANCE_RATIO"),$v("P54_POGCR_PDF_CANVAS_SIZE"),$v("P54_VDATE"),$v("P54_POG_POG_DEFAULT_COLOR"),$v("P54_POG_MODULE_DEFAULT_COLOR"),$v("P54_POGCR_DFT_SPREAD_PRODUCT"),$v("P54_PEGBOARD_DFT_HORZ_SPC"),$v("P54_PEGBOARD_DFT_VERT_SPC"),$v("P54_BASKET_WALL_THICK"),$v("P54_CHEST_WALL_THICK"),"Y",$v("P54_POGCR_DEFAULT_WRAP_TEXT"),$v("P54_POGCR_TEXT_DEFAULT_SIZE"),$v("P54_POG_TEXTBOX_DEFAULT_COLOR"),$v("P54_SHELF_DEFAULT_COLOR"),$v("P54_DIV_COLOR"),$v("P54_SLOT_DIVIDER"),$v("P54_SLOT_ORIENTATION"),$v("P54_DIVIDER_FIXED"),$v("P54_ITEM_DFT_COLOR"),$v("P54_POGCR_DFT_BASKET_FILL"),$v("P54_POGCR_DFT_BASKET_SPREAD"),$v("P54_POGCR_BAY_LIVE_IMAGE"),$v("P54_POGCR_BAY_WITHOUT_LIVE_IMAGE"),"Y");return removeLoadingIndicator(regionloadWait),"SUCCESS"}catch(e){throw error_handling(e),e}return"SUCCESS"}function get_textbox_z(e,_,o,t,a,r,n){try{var g=o-a/2,i=o+a/2,s=t+r/2,d=t-r/2,c=g_pog_json[n].ModuleInfo,l="N",P=0;for(const e of c){if("Y"==l)break;if(void 0===e.ParentModule||null==e.ParentModule){var E=e.ShelfInfo;for(const e of E){if("Y"==l)break;if("BASE"!==e.ObjType&&"NOTCH"!==e.ObjType&&"DIVIDER"!==e.ObjType&&"TEXTBOX"!==e.ObjType)if(e.ItemInfo.length>0){var O=e.ItemInfo;for(const _ of O){var v=_.X-_.W/2,T=_.X+_.W/2,h=_.Y+_.H/2,I=_.Y-_.H/2;if(g>=v&&g<T&&(s>I&&s<=h||d>=I&&d<h)||i>v&&i<=T&&(s>I&&s<=h||d>=I&&d<h)||g<v&&i>T&&(s>I&&s<=h||d>=I&&d<h)){l="Y",P=g_pog_json[n].BackDepth/2+e.D+.005;break}if(g>=v&&g&&s>h&&d<I||i>v&&i<=T&&s>h&&d<I){l="Y",P=g_pog_json[n].BackDepth/2+e.D+.005;break}1}}else{v=e.X-e.W/2,T=e.X+e.W/2,h=e.Y+e.H/2,I=e.Y-e.H/2;if(g>=v&&g<T&&(s>I&&s<=h||d>=I&&d<h)||i>v&&i<=T&&(s>I&&s<=h||d>=I&&d<h)||g<v&&i>T&&(s>I&&s<=h||d>=I&&d<h)){l="Y",P=g_pog_json[n].BackDepth/2+e.D+.005;break}if(g>=v&&g&&s>h&&d<I||i>v&&i<=T&&s>h&&d<I){l="Y",P=g_pog_json[n].BackDepth/2+e.D+.005;break}}1}}1}return"N"==l&&g_pog_json[n].ModuleInfo[e].ShelfInfo[_].Y-g_pog_json[n].ModuleInfo[e].ShelfInfo[_].H/2<=0?P=g_pog_json[n].BackDepth/2+.005+g_pog_json[n].BaseDepth:"N"==l&&(P=g_pog_json[n].BackDepth/2+.005),parseFloat(P.toFixed(3))}catch(e){error_handling(e)}}async function get_full_canvas(e,_){var o=document.getElementById("t_Header"),t=document.getElementById("top_bar"),a=document.getElementById("t_Body_nav"),r=document.getElementById("side_bar"),n=window.devicePixelRatio,g=null!==o?o.offsetHeight*n:0,i=null!==t?t.offsetHeight*n:0,s=null!==a?a.offsetWidth*n:0,d=null!==r?r.offsetWidth*n:0,c=document.createElement("canvas");g_windowHeight=window.innerHeight-(g+i),windowWidth=window.innerWidth-(s+d),c.width=windowWidth*_,c.height=g_windowHeight*_,g_camera=g_scene_objects[e].scene.children[0],g_scene_objects[e].scene.children[0].aspect=c.width/c.height,g_scene_objects[e].scene.children[0].updateProjectionMatrix();var l=get_min_max_xy(e).split("###");set_camera_z(g_camera,parseFloat(l[2]),parseFloat(l[3]),parseFloat(l[0]),parseFloat(l[1]),g_offset_z,parseFloat(l[4]),parseFloat(l[5]),!0,e);var P=c.getContext("2d");P.imageSmoothingEnabled=!0,g_renderer.setPixelRatio(window.devicePixelRatio);var E=c.width,O=c.height;return g_renderer.setSize(E,O),g_renderer.render(g_scene_objects[e].scene,g_scene_objects[e].scene.children[0]),P.drawImage(g_renderer.domElement,0,0,E,O),g_scene_objects[e].scene.children[0].aspect=g_canvas_objects[e].width/g_canvas_objects[e].height,g_scene_objects[e].scene.children[0].updateProjectionMatrix(),c}function get_json_data(e,_,o,t){try{return new Promise((function(a,r){apex.server.process("GET_POG_JSON",{x01:e,x02:_,x03:o,x04:t},{dataType:"html"}).done((function(e){-1==$.trim(e).indexOf("ERROR")?a(JSON.parse($.trim(e))):a($.trim(e))}))}))}catch(e){error_handling(e)}}async function generate_pdf(e){try{g_show_error=!1,g_req_count=0,g_renderer=new THREE.WebGLRenderer({canvas:g_canvas,antialias:!0}),g_renderer.setPixelRatio(window.devicePixelRatio),g_renderer.setClearColor(16777215);for(const e of l_pog_details)try{await init(0),objects={},objects.scene=g_scene,objects.renderer=g_renderer,g_scene_objects.push(objects),console.log("PDF Creation :",g_scene_objects,g_world,g_canvas_objects,e.POGCode,e.POGVersion);var _=await get_json_data(e.SeqNo,e.POGCode,e.POGVersion,e.SequenceId);if(-1==_.indexOf("ERROR")){var o=await create_module_from_json(_,"N","F","N","E","Y","Y",0,e);0==o.indexOf("ERROR:")&&raise_error(o)}else raise_error(_)}catch(_){apex.server.process("UPDATE_DETAIL_ERROR",{x01:e.SeqNo,x02:e.POGCode,x03:e.POGVersion,x04:_},{dataType:"text",success:function(e){g_req_count++,""!=$.trim(e)&&raise_error(e)}})}var t=setInterval((function(){g_req_count==l_pog_details.length&&(apex.item("P54_REFRESH_TIMER").setValue(0),$('[data-action= "refresh_timer"]').hide(),$('[data-action= "btn_download_pog_pdf"]').show(),$('[data-action= "btn_download_pog_zip"]').show(),$('[data-action= "btn_download_pog_concat"]').show(),$('[data-action= "btn_select_pog"]').show(),"B"==apex.item("P54_RUN_MODE").getValue()&&$('[data-action= "batch_print_pog"]').show(),apex.message.showPageSuccess(get_message("ALL_REQ_SUBMIT")),apex.region("pdf_batch_details").refresh(),clearInterval(t))}),200)}catch(e){throw error_handling(e),apex.item("P54_REFRESH_TIMER").setValue(0),void 0!==t&&clearInterval(t),e}}async function set_pegid(e,_){var o,t,a=0,r=[];for(var n of e[_].ModuleInfo){var g=0;for(var i of n.ShelfInfo){if("PEGBOARD"==i.ObjType)for(o=i.ItemInfo,z=1;z<=10;z++){var s=0;r=[];var d=[],c=i.Y+i.H/2;for(var l of o)void 0!==l.NewPegId&&""!=l.NewPegId||(t=parseFloat(l.Y+l.H/2).toFixed(4),r.push(parseFloat(c-t).toFixed(4)),d.push(s)),s++;var P=Math.min.apply(Math,r),E=r.findIndex((function(e){return e==P}));if(-1!==E){var O,v=e[_].ModuleInfo[a].ShelfInfo[g].ItemInfo[d[E]],T=(O=v.Y+v.H/2)-g_minvalue,h=O+g_minvalue;s=0;for(var l of o){if(void 0===l.NewPegId||""==l.NewPegId){var I=l.Y+l.H/2;I<=h&&I>=T&&(l.NewPegId=z)}s++}}}g++}a++}}