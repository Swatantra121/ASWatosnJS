var g_RouteTravelPath,g_arrow,g_pathLength,g_animate,g_pathColor,g_fillColor,g_progress=0,g_current_floor=0;function drawPath(t,e,o,r,n){var i;if(removePath(e.className),null!==(i=""!=n&&void 0!==n&&null!=n?$('#IFP_Floor[value="'+n+'"]').siblings(e.mapSelector):document.querySelector(e.mapSelector))){var a=createElement("path"),l=getD(t,e.smoothing,o,r,n);a.setAttribute("id","RouteTravelPath"),a.setAttribute("class",e.className),a.setAttribute("fill","none"),a.setAttribute("stroke",e.lineColor),a.setAttribute("stroke-width",e.lineWidth),a.setAttribute("d",l),i.after(a);var s=document.createElement("circle");s.setAttribute("id","Circle"),s.setAttribute("class",e.className),s.setAttribute("cx","10"),s.setAttribute("cy","10"),s.setAttribute("r","50"),s.setAttribute("fill","red"),s.setAttribute("stroke","red"),s.setAttribute("d",l),i.after(s);var c=createElement("polygon");c.setAttribute("class","arrow"),c.setAttribute("points","0,0 15,10 0,20"),c.setAttribute("transform","translate(0, 0)"),c.setAttribute("stroke",e.lineColor),c.setAttribute("fill",e.lineColor),i.after(c),g_RouteTravelPath=document.getElementById("RouteTravelPath"),g_arrow=document.querySelector(".arrow"),g_pathLength=g_RouteTravelPath.getTotalLength(),g_progress=0,animate()}}function removePath(t){document.querySelectorAll("."+t).forEach((t=>t.remove())),document.querySelectorAll(".arrow").forEach((t=>t.remove())),cancelAnimationFrame(g_animate),g_RouteTravelPath="",g_animate="",g_arrow="",g_pathLength=0,g_progress=0}function getPathDistance(t){var e=t[0];return t[t.length-1].distance-e.distance}function findclosingend(t,e,o,r){var n,i={};n=""!=r&&void 0!==r&&null!=r?Array.from($('#IFP_Floor[value="'+r+'"]').siblings("#routes").children()):Array.from(document.getElementById("routes").children);var a=0,l=t[e];n.forEach((function(r){var n=r.getAttribute("lineid");if(null!=n&&n.indexOf(o)>=0){l.x==r.x1.baseVal.value&&l.y==r.y1.baseVal.value?(a=getDistance({x:l.x,y:l.y},{x:r.x2.baseVal.value,y:r.y2.baseVal.value}),i={x:r.x2.baseVal.value,y:r.y2.baseVal.value,id:n,distance:0}):l.x==r.x2.baseVal.value&&l.y==r.y2.baseVal.value&&(a=getDistance({x:l.x,y:l.y},{x:r.x1.baseVal.value,y:r.y1.baseVal.value}),i={x:r.x1.baseVal.value,y:r.y1.baseVal.value,id:n,distance:l.distance+a});var s=!0;return t.forEach((function(t,e){t.x==i.x&&t.y==i.y&&(s=!1)})),void(s&&(0==e?(t.unshift(i),t.forEach((function(e,o){t[o].distance=0==o?0:t[o].distance+a}))):t.push(i)))}}))}function getD(t,e,o,r,n){findclosingend(t,0,o,n),findclosingend(t,t.length-1,r,n);var i="M ".concat(t[0].x,",").concat(t[0].y);return t.forEach((function(o,r){if(r>0&&r<t.length-1){var n=getLinePoint(t[r],t[r-1],e),a=getLinePoint(t[r],t[r+1],e);i+=" L".concat(n.x,",").concat(n.y),i+=" Q".concat(o.x,",").concat(o.y),i+=" ".concat(a.x,",").concat(a.y)}else i+=" L".concat(o.x,",").concat(o.y)})),i}function getLinePoint(t,e,o){var r=e.x-t.x,n=e.y-t.y,i=Math.abs(t.distance-e.distance),a=Math.min(o,i/2)/i;return{x:t.x+r*a,y:t.y+n*a}}function createElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function isLine(t){return"line"===t.tagName}function getGraphfloor(t,e,o){return(""!=o&&void 0!==o&&null!=o?Array.from($('#IFP_Floor[value="'+o+'"]').siblings("#routes").children()):Array.from(document.querySelectorAll("#routes")).flatMap((t=>Array.from(t.children)))).forEach((function(o){isLine(o)?handleLine(o,t,e):console.error("Invalid element in routes: ".concat(o.tagName))})),t}function getPath(t,e,o){var r=filterPointsByLocationId(t,e),n=filterPointsByLocationId(t,o);return r.length&&n.length?(clearPath(t),r.forEach((function(t){return t.distance=0})),setPathPoints(t),getPathPoints(n)):[]}function handleLine(t,e,o){var r=t.getAttribute("lineid"),n=addPoint(t.x1.baseVal.value,t.y1.baseVal.value,r,e),i=addPoint(t.x2.baseVal.value,t.y2.baseVal.value,r,e),a=getDistance(n,i);linkPoint(n,i,a),linkPoint(i,n,a)}function addPoint(t,e,o,r){var n=findPoint(r,t,e,o);if(n)return n;var i={x:t,y:e,id:o,distance:Number.POSITIVE_INFINITY,previous:void 0,links:[]};return r.push(i),i}function getDistance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}function findPoint(t,e,o,r){return t.find((function(t){if(t.x===e&&t.y===o)return null!=r&&null==t.id&&(t.id=r),t}))}function linkPoint(t,e,o){findPoint(t.links.map((function(t){return t.to})),e.x,e.y)||t.links.push({to:e,distance:o})}function filterPointsByLocationId(t,e){var o=t.filter((function(t){if(t.id===e)return t.id}));return o.length||(o=t.filter((function(t){if(t.id===e)return t.id}))),o.length?o:(alert(get_message("FLOORPLAN_PATH_NOTFOUND",e)),[])}function FindPointsByLocationId(t,e,o){var r="point-",n=[],i=$v("P176_SHOW_MY_PATH_PRIORITY"),a={L:[],E:[],S:[]},l=i.split(">").map((t=>t.split("=")));t.forEach((function(t){if(null!=t.id&&(t.id.indexOf(r+e)>=0||"EX"===e&&t.id.includes(r+"ENEX"))){if(null!==o&&"EX"===e){if(!t.id.split("_").pop().split(",").map(Number).includes(Number(o)))return}t.id.includes("_L_")&&a.L.push(t.id),t.id.includes("_E_")&&a.E.push(t.id),t.id.includes("_S_")&&a.S.push(t.id)}}));for(let t of l){let e=[];for(let o of t)if(a.hasOwnProperty(o)&&a[o].length>0){e=a[o];break}if(e.length>0){n=e;break}}return 0===n.length&&t.forEach((function(t){null!=t.id&&t.id.indexOf(r+e)>=0&&n.push(t.id)})),n}function clearPath(t){for(const e of t)e.previous=void 0,e.distance=Number.POSITIVE_INFINITY}function setPathPoints(t){for(var e=t;e.length>0;){for(var o=0,r=Number.POSITIVE_INFINITY,n=0;n<e.length;n++)e[n].distance<r&&(o=n,r=e[n].distance);var i=e[o];e.splice(o,1);for(const t of i.links){const e=i.distance+t.distance;e<t.to.distance&&(t.to.distance=e,t.to.previous=i)}}}function getPathPoints(t){var e=[],o=null,r=Number.POSITIVE_INFINITY;for(const e of t)e.distance<r&&(r=(o=e).distance);if(!o)return[];for(e.push(o);void 0!==o.previous;)o=o.previous,e.unshift(o);return e}function extractSegmentsByIdentifier(t,e){let o=t.split(":").filter(Boolean),r=null;return o.forEach((t=>{let[o,n]=t.split("#");n===e&&(r=o)})),r?o.filter((t=>{let[e,o]=t.split("#");return e===r})).join(":"):t}function removeSegmentsByIdentifier(t,e){let o=t.split(":").filter(Boolean),r=null;return o.forEach((t=>{let[o,n]=t.split("#");n===e&&(r=o)})),r?o.filter((t=>{let[o,n]=t.split("#");return o!==r&&n!=e})).join(":"):t}function getIdCounts(t){if(!t)return 0;const e=t.split(":").filter((t=>""!==t.trim()));let o=new Set;for(let t=0;t<e.length;t++){const[r,n]=e[t].split("#"),i=Array.from(o).some((t=>t.startsWith(r+"#"))),a=Array.from(o).some((t=>t.endsWith("#"+n)));i||a||o.add(e[t])}return o.size}function findClosestEntryExit(t,e){let o=document.querySelector(`g[Location_ID_Fixture='${t}']`);if(!o)return null;let r=o.getBoundingClientRect();var n=null,i=null;let a=1/0;return e.forEach((t=>{let e=t.getBoundingClientRect(),o=Math.hypot(e.x-r.x,e.y-r.y);o<a&&(a=o,"Entry_Exit"==t.getAttribute("id")?(n="ENEX",i=t):"Entry_"==t.getAttribute("id")&&(n="EN",i=t))})),[n,i]}function drawSingleFloorPath(t,e,o,r,n,i){var a=[],l=(getGraphfloor(a,o,r),[]),s=FindPointsByLocationId(a,t.toUpperCase(),["EX","ENEX"].includes(t.toUpperCase())?parseInt(r)+1:null);if(0==s.length)return alert(get_message("FLOORPLAN_PATH_NOTFOUND",t.toUpperCase())),void removeLoadingIndicator(regionloadWait);var c=FindPointsByLocationId(a,e.toUpperCase(),["EX","ENEX"].includes(e.toUpperCase())?parseInt(r)>parseInt(i)?parseInt(r)-1:parseInt(r)+1:null);if(0==c.length)return alert(get_message("FLOORPLAN_PATH_NOTFOUND",e.toUpperCase())),void removeLoadingIndicator(regionloadWait);var u=[];s.forEach((function(t){c.forEach((function(e){u.push({FromLocID:t,ToLocID:e,distance:0,path:""})}))}));var d,_=Number.POSITIVE_INFINITY;u.forEach((function(t,e){var n=getPath(getGraphfloor(a=[],o,r),t.FromLocID,t.ToLocID);t.path=n,0==n.length?t.distance=Number.POSITIVE_INFINITY:(t.distance=getPathDistance(n),_>t.distance&&(d=e,_=t.distance))}));let f=u.reduce(((t,e)=>t.distance<e.distance?t:e));return f.path.length&&(l={ToLocID:f.ToLocID,distance:f.distance,path:f.path,FromLocID:f.FromLocID,x01:u[d].path,x02:o,x03:u[d].FromLocID,x04:u[d].ToLocID,other_floor_LocID:n,other_toFloor:i}),l}function draw_button(t,e,o,r,n,i,a,l){let s,c;if(s=""!=e&&void 0!==e?$('#IFP_Floor[value="'+e+'"]').siblings("#Paths").find('path[Line_ID_Fixture="'+t+'"]').attr("d"):document.querySelector('path[Line_ID_Fixture="'+t+'"]').getAttribute("d"),c=""!=e&&void 0!==e?$('#IFP_Floor[Value="'+e+'"]').siblings("#Paths").find('path[d="'+s+'"]')[0]:document.querySelector('path[d^="'+s+'"]'),c){let s=c.getBoundingClientRect(),u=document.createElement("div");u.style.position="absolute",u.style.left=`${s.left+window.scrollX+s.width/2}px`,u.style.top=s.top+window.scrollY-30+"px",u.style.transform="translate(-50%, -100%)",u.style.zIndex="1000";let d=document.createElement("div");d.innerHTML=g_current_floor>a?get_message("GO_DN_FLOOR",parseInt(g_current_floor)-parseInt(a)):get_message("GO_UP_FLOOR",parseInt(g_current_floor)-parseInt(a)),d.style.backgroundColor="red",d.style.color="white",d.style.padding="5px 10px",d.style.borderRadius="5px",d.style.fontSize="12px",d.style.cursor="pointer",d.style.textAlign="center",d.style.marginBottom="5px",d.style.boxShadow="2px 2px 5px rgba(0,0,0,0.3)";let _=document.createElement("button");_.innerText=g_current_floor>a?get_message("GO_TO_FLOOR",parseInt(e)-1):get_message("GO_TO_FLOOR",parseInt(e)+1),_.style.backgroundColor="red",_.style.color="white",_.style.border="none",_.style.padding="5px 10px",_.style.borderRadius="5px",_.style.boxShadow="2px 2px 5px rgba(0,0,0,0.3)",_.style.cursor="pointer",u.appendChild(d),u.appendChild(_),document.body.appendChild(u),[d,_].forEach((s=>s.addEventListener("click",(function(){document.querySelectorAll("div, button").forEach((t=>{t.innerText.includes("Go")&&t.remove()})),g_current_floor=g_current_floor>a?parseInt(g_current_floor)-1:parseInt(g_current_floor)+1;var s=[],c=t,u="ENEX";if(t.includes("EX")&&!t.includes("ENEX")?(c=t.replace("EX","EN"),u="EX"):t.includes("EN")&&!t.includes("ENEX")&&(c=t.replace("EN","EX"),u="EN"),-1==t.split("_").pop().split(",").map(Number).indexOf(parseInt(e)+2)&&(u="ENEX"),a!=String(g_current_floor)){var d=drawSingleFloorPath(c,u,o,String(g_current_floor),n,String(g_current_floor));s.push(d)}else{d=drawSingleFloorPath(c,i,o,String(g_current_floor),n,String(a));s.push(d)}let _=s.reduce(((t,e)=>t.distance<e.distance?t:e));_&&drawPath(_.x01,_.x02,_.x03,_.x04,String(g_current_floor)),a!=String(g_current_floor)?($("#id_previous_location").css("display","none"),$("#id_next_location").css("display","none"),draw_button(_.x04.split("-")[1],g_current_floor,o,r,n,i,a,l)):hide_show_button(_,l,n,i)}))))}}function getFloor(t){let e=document.querySelector(`#routes line[lineid='point-${t}']`);if(!e)return console.warn(`Location ${t} not found`),null;var o=e.parentElement.parentElement.getElementById("IFP_Floor");return $(o).attr("value")}function getGraph(t,e){return Array.from(document.querySelectorAll("#IFP_Floor ~ g#routes")).flatMap((t=>Array.from(t.children))).forEach((function(o){isLine(o)?handleLine(o,t,e):console.error("Invalid element in routes: ".concat(o.tagName))})),t}function hide_show_button(t,e,o,r){let n=0,i=t.ToLocID.split("-")[1];if("Y"==checkSameProduct($v("P176_POG_LOCATION_IDS")))$("#id_next_location").css("display","none"),$("#id_previous_location").css("display","none"),get_svg_footer(r);else{if($s("P176_FROM_LOCATION_ID",i),!$v("P176_LOCATION_IDS").includes(e)){let t=extractSegmentsByIdentifier($v("P176_POG_LOCATION_IDS"),e)+":"+$v("P176_LOCATION_IDS");$s("P176_LOCATION_IDS",t)}if(i&&!i.includes(",")){let t=$v("P176_PREVIOUS_LOCATION_IDS");if(t.includes(i)){let e=t;n=e.indexOf(i)+i.length;let o=e.slice(n);$s("P176_PREVIOUS_LOCATION_IDS",o),""===o&&($s("P176_LOCATION_IDS",$v("P176_POG_LOCATION_IDS")),$("#id_next_location").css("display","block"))}else $s("P176_PREVIOUS_LOCATION_IDS",":#"+e+t)}0!==n||i.toUpperCase().includes(",")||""!=r||void 0!==r?get_svg_footer(r):get_svg_footer(i.toUpperCase()),getIdCounts($v("P176_LOCATION_IDS"))>1?(0!==n||i.toUpperCase().includes(",")?get_svg_footer(r):($s("P176_LOCATION_IDS",removeSegmentsByIdentifier(o,i.toUpperCase())),""!=r||void 0!==r?get_svg_footer(r):get_svg_footer(i.toUpperCase())),$s("P176_PREVIOUS_LOCATION_ID",e,":#"+$v("P176_PREVIOUS_LOCATION_ID")),$("#id_next_location").css("display",""===$v("P176_LOCATION_IDS")?"none":"block")):$("#id_next_location").css("display","none"),$v("P176_PREVIOUS_LOCATION_IDS").split("#").length-1>0&&($s("P176_PREVIOUS_LOCATION_ID",e),$("#id_previous_location").css("display","block"));let t=getIdCounts($v("P176_LOCATION_IDS"));getIdCounts($v("P176_POG_LOCATION_IDS"))!==t+1&&""!==$v("P176_PREVIOUS_LOCATION_IDS")||$("#id_previous_location").css("display","none"),""!==$v("P176_PREVIOUS_LOCATION_IDS")?$("#id_previous_location").css("display","block"):$("#id_previous_location").css("display","none"),t>0&&$("#id_next_location").css("display","block")}}function findPathAndDraw(t,e,o,r,n="N"){var i={mapSelector:"#Global_Layer",className:"routepath",smoothing:1,lineColor:"darkblue",lineWidth:5,speed:5};document.querySelectorAll("div, button").forEach((t=>{t.innerText.includes("Go")&&t.remove()})),removePath(i.className);var a=[];Array.from(document.querySelectorAll("g#LocIDDisplay_Inside_Block path")).forEach((function(r){r.getAttribute("location_id")==t?(r.setAttribute("fill","red"),r.setAttribute("stroke","red")):e.includes(r.getAttribute("location_id"))?(r.setAttribute("fill","green"),r.setAttribute("stroke","green")):o.includes(r.getAttribute("location_id"))?(r.setAttribute("fill","yellow"),r.setAttribute("stroke","yellow")):(r.setAttribute("fill",g_fillColor),r.setAttribute("stroke",g_pathColor))}));var l=t;let s=getFloor(l);var c=[];if(r){if(e.split(":").filter(Boolean).forEach(((t,e)=>{var[o,r]=t.split("#"),n=r;getGraph([],i);let u=getFloor(n);if(s==u){var d=drawSingleFloorPath(l.toUpperCase(),n.toUpperCase(),i,s,"","");a.push(d)}else""!=u&&null!=u&&c.push({ToLocID:n,toFloor:u})})),c.sort(((t,e)=>t.toFloor-e.toFloor)),0==a.length&&c.length>0){var u=drawSingleFloorPath(l.toUpperCase(),"EX",i,s,c[0].ToLocID,c[0].toFloor);a.push(u);var d=[];c.forEach((t=>{if(c[0].toFloor==t.toFloor){var e=t.ToLocID,o=(getGraph([],i),drawSingleFloorPath(a[0].ToLocID.split("-")[1],e.toUpperCase(),i,a[0].other_toFloor,"",""));d.push(o)}}));let t=d.reduce(((t,e)=>t.distance<e.distance?t:e));a.length>0&&(a[0].other_floor_LocID=t.ToLocID.split("-")[1])}if("Y"==n||"YY"==n){let o=a.reduce(((t,e)=>t.distance<e.distance?t:e));var _,f=getFloor(o.FromLocID.split("-")[1]);_=""!==o.other_floor_LocID?getFloor(o.other_floor_LocID):f,o&&(drawPath(o.x01,o.x02,o.x03,o.x04,f),_!=f?(g_current_floor=f,draw_button(o.x04.split("-")[1],f,i,n,e,o.other_floor_LocID,o.other_toFloor,o.FromLocID.split("-")[1]),$("#id_previous_location").css("display","none"),$("#id_next_location").css("display","none")):"YY"!=n&&hide_show_button(o,t,e,o.other_floor_LocID?o.other_floor_LocID:o.ToLocID.split("-")[1]))}}}function Hide_paths(){document.querySelectorAll("#Paths").forEach((function(t){if(t){var e=document.querySelector("#LocIDDisplay_Inside_Block");if(e){var o=Array.from(e.getElementsByTagName("path"));o.length>0&&(g_pathColor=o[0].getAttribute("stroke"),g_fillColor=o[0].getAttribute("fill"))}Array.from(t.getElementsByTagName("path")).forEach((function(t){t.setAttribute("stroke-opacity","0")}))}})),document.querySelectorAll("#routes").forEach((function(t){t.setAttribute("stroke-opacity","0")}))}function show_paths(){Array.from(document.getElementById("Paths").getElementsByTagName("path")).forEach((function(t){t.setAttribute("stroke-opacity","1")})),document.getElementById("routes").setAttribute("stroke-opacity","1")}function animate(){(g_progress+=.002)>1&&(g_progress=0);const t=g_RouteTravelPath.getPointAtLength(g_progress*g_pathLength);var e,o=g_arrow.getAttribute("transform");if(""!=o)var r=parseFloat(o.slice(o.indexOf("translate(")+10,o.indexOf(","))),n=parseFloat(o.slice(o.indexOf(",")+1,o.indexOf(")")));else r=t.x-10,n=t.y-10;e=r>t.x-10?180:r<t.x-10?0:n<t.y-10?90:-90,g_arrow.setAttribute("transform",`translate(${t.x-10}, ${t.y-10}) rotate(${e}, 10, 10)`),g_animate=requestAnimationFrame(animate)}function isMobileDevice(){return/Mobi|Android/i.test(navigator.userAgent)}function smw_kiosk_cnfg(t,e,o){let r=[];var n=document.getElementById("LocIDDisplay_Inside_Block");Array.from(n.getElementsByTagName("path")).forEach((function(e){const o=e.getAttribute("location_id");o&&o.includes(t)&&r.push(o)})),r.sort(),0!=r.length?""===r[0]&&void 0===r[0]||(findPathAndDraw(r[0],e,o,!0,"Y"),$s("P176_PREVIOUS_LOCATION_IDS",":#"+r[0])):""==$v("P171_DUMMY_LOCATION_IDS")&&(isMobileDevice()?openInlineDialog("reg_set_location",90,90):openInlineDialog("reg_set_location",30,30)),removeLoadingIndicator(regionloadWait)}function checkSameProduct(t){if(!t||"string"!=typeof t)return"N";const e=t.split(":").filter(Boolean);if(0===e.length)return"N";const o=e.map((t=>t.split("#")[0])),r=e.map((t=>t.split("#")[1])),n=new Set(o),i=new Set(r);return 1===n.size||1===i.size?"Y":"N"}